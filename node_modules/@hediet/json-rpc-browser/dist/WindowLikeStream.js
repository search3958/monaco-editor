import { BaseMessageTransport } from "@hediet/json-rpc";
export class WindowLikeTransport extends BaseMessageTransport {
    _windowLike;
    _source;
    _loadingState;
    _disposed = false;
    constructor(_windowLike, _source = undefined, _loadingState = undefined) {
        super();
        this._windowLike = _windowLike;
        this._source = _source;
        this._loadingState = _loadingState;
        this._windowLike.addEventListener("message", this._messageHandler);
    }
    _messageHandler = ({ data, source }) => {
        if (this._source && source !== this._source) {
            return;
        }
        if (typeof data === "object" && data) {
            this._dispatchReceivedMessage(data);
        }
    };
    async _sendImpl(message) {
        if (this._disposed) {
            throw new Error("Transport is disposed");
        }
        if (this._loadingState && !this._loadingState.loaded) {
            await this._loadingState.onLoaded;
        }
        this._windowLike.postMessage(message);
    }
    toString() {
        return `${this.id}@${this._windowLike}`;
    }
    dispose() {
        if (this._disposed) {
            return;
        }
        this._disposed = true;
        this._windowLike.removeEventListener("message", this._messageHandler);
    }
}
//# sourceMappingURL=WindowLikeStream.js.map