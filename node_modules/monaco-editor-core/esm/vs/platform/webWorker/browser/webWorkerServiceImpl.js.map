{"version":3,"sources":["file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src/vs/platform/webWorker/browser/webWorkerServiceImpl.ts","vs/platform/webWorker/browser/webWorkerServiceImpl.ts"],"names":[],"mappings":"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","file":"webWorkerServiceImpl.js","sourceRoot":"file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { createTrustedTypesPolicy } from '../../../base/browser/trustedTypes.js';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { onUnexpectedError } from '../../../base/common/errors.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { COI } from '../../../base/common/network.js';\nimport { IWebWorker, IWebWorkerClient, Message, WebWorkerClient } from '../../../base/common/worker/webWorker.js';\nimport { getNLSLanguage, getNLSMessages } from '../../../nls.js';\nimport { WebWorkerDescriptor } from './webWorkerDescriptor.js';\nimport { IWebWorkerService } from './webWorkerService.js';\n\nexport class WebWorkerService implements IWebWorkerService {\n\tprivate static _workerIdPool: number = 0;\n\tdeclare readonly _serviceBrand: undefined;\n\n\tcreateWorkerClient<T extends object>(workerDescriptor: WebWorkerDescriptor | Worker | Promise<Worker>): IWebWorkerClient<T> {\n\t\tlet worker: Worker | Promise<Worker>;\n\t\tconst id = ++WebWorkerService._workerIdPool;\n\t\tif (workerDescriptor instanceof Worker || isPromiseLike<Worker>(workerDescriptor)) {\n\t\t\tworker = Promise.resolve(workerDescriptor);\n\t\t} else {\n\t\t\tworker = this._createWorker(workerDescriptor);\n\t\t}\n\n\t\treturn new WebWorkerClient<T>(new WebWorker(worker, id));\n\t}\n\n\tprotected _createWorker(descriptor: WebWorkerDescriptor): Promise<Worker> {\n\t\tconst workerRunnerUrl = this.getWorkerUrl(descriptor);\n\n\t\tconst workerUrlWithNls = getWorkerBootstrapUrl(descriptor.label, workerRunnerUrl, this._getWorkerLoadingFailedErrorMessage(descriptor));\n\t\tconst worker = new Worker(ttPolicy ? ttPolicy.createScriptURL(workerUrlWithNls) as unknown as string : workerUrlWithNls, { name: descriptor.label, type: 'module' });\n\t\treturn whenESMWorkerReady(worker);\n\t}\n\n\tprotected _getWorkerLoadingFailedErrorMessage(_descriptor: WebWorkerDescriptor): string | undefined {\n\t\treturn undefined;\n\t}\n\n\tgetWorkerUrl(descriptor: WebWorkerDescriptor): string {\n\t\tif (!descriptor.esmModuleLocation) {\n\t\t\tthrow new Error('Missing esmModuleLocation in WebWorkerDescriptor');\n\t\t}\n\t\tconst uri = typeof descriptor.esmModuleLocation === 'function' ? descriptor.esmModuleLocation() : descriptor.esmModuleLocation;\n\t\tconst urlStr = uri.toString(true);\n\t\treturn urlStr;\n\t}\n}\n\nconst ttPolicy = ((): ReturnType<typeof createTrustedTypesPolicy> => {\n\ttype WorkerGlobalWithPolicy = typeof globalThis & {\n\t\tworkerttPolicy?: ReturnType<typeof createTrustedTypesPolicy>;\n\t};\n\n\t// Reuse the trusted types policy defined from worker bootstrap\n\t// when available.\n\t// Refs https://github.com/microsoft/vscode/issues/222193\n\tconst workerGlobalThis = globalThis as WorkerGlobalWithPolicy;\n\tif (typeof self === 'object' && self.constructor && self.constructor.name === 'DedicatedWorkerGlobalScope' && workerGlobalThis.workerttPolicy !== undefined) {\n\t\treturn workerGlobalThis.workerttPolicy;\n\t} else {\n\t\treturn createTrustedTypesPolicy('defaultWorkerFactory', { createScriptURL: value => value });\n\t}\n})();\n\nfunction getWorkerBootstrapUrl(label: string, workerScriptUrl: string, workerLoadingFailedErrorMessage: string | undefined): string {\n\tif (/^((http:)|(https:)|(file:))/.test(workerScriptUrl) && workerScriptUrl.substring(0, globalThis.origin.length) !== globalThis.origin) {\n\t\t// this is the cross-origin case\n\t\t// i.e. the webpage is running at a different origin than where the scripts are loaded from\n\t} else {\n\t\tconst start = workerScriptUrl.lastIndexOf('?');\n\t\tconst end = workerScriptUrl.lastIndexOf('#', start);\n\t\tconst params = start > 0\n\t\t\t? new URLSearchParams(workerScriptUrl.substring(start + 1, ~end ? end : undefined))\n\t\t\t: new URLSearchParams();\n\n\t\tCOI.addSearchParam(params, true, true);\n\t\tconst search = params.toString();\n\t\tif (!search) {\n\t\t\tworkerScriptUrl = `${workerScriptUrl}#${label}`;\n\t\t} else {\n\t\t\tworkerScriptUrl = `${workerScriptUrl}?${params.toString()}#${label}`;\n\t\t}\n\t}\n\n\t// In below blob code, we are using JSON.stringify to ensure the passed\n\t// in values are not breaking our script. The values may contain string\n\t// terminating characters (such as ' or \").\n\tconst blob = new Blob([coalesce([\n\t\t`/*${label}*/`,\n\t\t`globalThis._VSCODE_NLS_MESSAGES = ${JSON.stringify(getNLSMessages())};`,\n\t\t`globalThis._VSCODE_NLS_LANGUAGE = ${JSON.stringify(getNLSLanguage())};`,\n\t\t`globalThis._VSCODE_FILE_ROOT = ${JSON.stringify(globalThis._VSCODE_FILE_ROOT)};`,\n\t\t`const ttPolicy = globalThis.trustedTypes?.createPolicy('defaultWorkerFactory', { createScriptURL: value => value });`,\n\t\t`globalThis.workerttPolicy = ttPolicy;`,\n\n\t\tworkerLoadingFailedErrorMessage ? 'try {' : '',\n\t\t`await import(ttPolicy?.createScriptURL(${JSON.stringify(workerScriptUrl)}) ?? ${JSON.stringify(workerScriptUrl)});`,\n\t\tworkerLoadingFailedErrorMessage ? `} catch (err) { console.error(${JSON.stringify(workerLoadingFailedErrorMessage)}, err); throw err; }` : '',\n\n\t\t`globalThis.postMessage({ type: 'vscode-worker-ready' });`,\n\t\t`/*${label}*/`\n\t]).join('')], { type: 'application/javascript' });\n\treturn URL.createObjectURL(blob);\n}\n\nfunction whenESMWorkerReady(worker: Worker): Promise<Worker> {\n\treturn new Promise<Worker>((resolve, reject) => {\n\t\tworker.onmessage = function (e) {\n\t\t\tif (e.data.type === 'vscode-worker-ready') {\n\t\t\t\tworker.onmessage = null;\n\t\t\t\tresolve(worker);\n\t\t\t}\n\t\t};\n\t\tworker.onerror = reject;\n\t});\n}\n\nfunction isPromiseLike<T>(obj: unknown): obj is PromiseLike<T> {\n\treturn !!obj && typeof (obj as PromiseLike<T>).then === 'function';\n}\n\nexport class WebWorker extends Disposable implements IWebWorker {\n\tprivate readonly id: number;\n\tprivate worker: Promise<Worker> | null;\n\n\tprivate readonly _onMessage = this._register(new Emitter<Message>());\n\tpublic readonly onMessage = this._onMessage.event;\n\n\tprivate readonly _onError = this._register(new Emitter<MessageEvent | ErrorEvent>());\n\tpublic readonly onError = this._onError.event;\n\n\tconstructor(worker: Promise<Worker>, id: number) {\n\t\tsuper();\n\t\tthis.id = id;\n\t\tthis.worker = worker;\n\t\tthis.postMessage('-please-ignore-', []); // TODO: Eliminate this extra message\n\t\tconst errorHandler = (ev: ErrorEvent) => {\n\t\t\tthis._onError.fire(ev);\n\t\t};\n\t\tthis.worker.then((w) => {\n\t\t\tw.onmessage = (ev) => {\n\t\t\t\tthis._onMessage.fire(ev.data);\n\t\t\t};\n\t\t\tw.onmessageerror = (ev) => {\n\t\t\t\tthis._onError.fire(ev);\n\t\t\t};\n\t\t\tif (typeof w.addEventListener === 'function') {\n\t\t\t\tw.addEventListener('error', errorHandler);\n\t\t\t}\n\t\t});\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis.worker?.then(w => {\n\t\t\t\tw.onmessage = null;\n\t\t\t\tw.onmessageerror = null;\n\t\t\t\tw.removeEventListener('error', errorHandler);\n\t\t\t\tw.terminate();\n\t\t\t});\n\t\t\tthis.worker = null;\n\t\t}));\n\t}\n\n\tpublic getId(): number {\n\t\treturn this.id;\n\t}\n\n\tpublic postMessage(message: unknown, transfer: Transferable[]): void {\n\t\tthis.worker?.then(w => {\n\t\t\ttry {\n\t\t\t\tw.postMessage(message, transfer);\n\t\t\t} catch (err) {\n\t\t\t\tonUnexpectedError(err);\n\t\t\t\tonUnexpectedError(new Error(`FAILED to post message to worker`, { cause: err }));\n\t\t\t}\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { createTrustedTypesPolicy } from '../../../base/browser/trustedTypes.js';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { onUnexpectedError } from '../../../base/common/errors.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { COI } from '../../../base/common/network.js';\nimport { IWebWorker, IWebWorkerClient, Message, WebWorkerClient } from '../../../base/common/worker/webWorker.js';\nimport { getNLSLanguage, getNLSMessages } from '../../../nls.js';\nimport { WebWorkerDescriptor } from './webWorkerDescriptor.js';\nimport { IWebWorkerService } from './webWorkerService.js';\n\nexport class WebWorkerService implements IWebWorkerService {\n\tprivate static _workerIdPool: number = 0;\n\tdeclare readonly _serviceBrand: undefined;\n\n\tcreateWorkerClient<T extends object>(workerDescriptor: WebWorkerDescriptor | Worker | Promise<Worker>): IWebWorkerClient<T> {\n\t\tlet worker: Worker | Promise<Worker>;\n\t\tconst id = ++WebWorkerService._workerIdPool;\n\t\tif (workerDescriptor instanceof Worker || isPromiseLike<Worker>(workerDescriptor)) {\n\t\t\tworker = Promise.resolve(workerDescriptor);\n\t\t} else {\n\t\t\tworker = this._createWorker(workerDescriptor);\n\t\t}\n\n\t\treturn new WebWorkerClient<T>(new WebWorker(worker, id));\n\t}\n\n\tprotected _createWorker(descriptor: WebWorkerDescriptor): Promise<Worker> {\n\t\tconst workerRunnerUrl = this.getWorkerUrl(descriptor);\n\n\t\tconst workerUrlWithNls = getWorkerBootstrapUrl(descriptor.label, workerRunnerUrl, this._getWorkerLoadingFailedErrorMessage(descriptor));\n\t\tconst worker = new Worker(ttPolicy ? ttPolicy.createScriptURL(workerUrlWithNls) as unknown as string : workerUrlWithNls, { name: descriptor.label, type: 'module' });\n\t\treturn whenESMWorkerReady(worker);\n\t}\n\n\tprotected _getWorkerLoadingFailedErrorMessage(_descriptor: WebWorkerDescriptor): string | undefined {\n\t\treturn undefined;\n\t}\n\n\tgetWorkerUrl(descriptor: WebWorkerDescriptor): string {\n\t\tif (!descriptor.esmModuleLocation) {\n\t\t\tthrow new Error('Missing esmModuleLocation in WebWorkerDescriptor');\n\t\t}\n\t\tconst uri = typeof descriptor.esmModuleLocation === 'function' ? descriptor.esmModuleLocation() : descriptor.esmModuleLocation;\n\t\tconst urlStr = uri.toString(true);\n\t\treturn urlStr;\n\t}\n}\n\nconst ttPolicy = ((): ReturnType<typeof createTrustedTypesPolicy> => {\n\ttype WorkerGlobalWithPolicy = typeof globalThis & {\n\t\tworkerttPolicy?: ReturnType<typeof createTrustedTypesPolicy>;\n\t};\n\n\t// Reuse the trusted types policy defined from worker bootstrap\n\t// when available.\n\t// Refs https://github.com/microsoft/vscode/issues/222193\n\tconst workerGlobalThis = globalThis as WorkerGlobalWithPolicy;\n\tif (typeof self === 'object' && self.constructor && self.constructor.name === 'DedicatedWorkerGlobalScope' && workerGlobalThis.workerttPolicy !== undefined) {\n\t\treturn workerGlobalThis.workerttPolicy;\n\t} else {\n\t\treturn createTrustedTypesPolicy('defaultWorkerFactory', { createScriptURL: value => value });\n\t}\n})();\n\nfunction getWorkerBootstrapUrl(label: string, workerScriptUrl: string, workerLoadingFailedErrorMessage: string | undefined): string {\n\tif (/^((http:)|(https:)|(file:))/.test(workerScriptUrl) && workerScriptUrl.substring(0, globalThis.origin.length) !== globalThis.origin) {\n\t\t// this is the cross-origin case\n\t\t// i.e. the webpage is running at a different origin than where the scripts are loaded from\n\t} else {\n\t\tconst start = workerScriptUrl.lastIndexOf('?');\n\t\tconst end = workerScriptUrl.lastIndexOf('#', start);\n\t\tconst params = start > 0\n\t\t\t? new URLSearchParams(workerScriptUrl.substring(start + 1, ~end ? end : undefined))\n\t\t\t: new URLSearchParams();\n\n\t\tCOI.addSearchParam(params, true, true);\n\t\tconst search = params.toString();\n\t\tif (!search) {\n\t\t\tworkerScriptUrl = `${workerScriptUrl}#${label}`;\n\t\t} else {\n\t\t\tworkerScriptUrl = `${workerScriptUrl}?${params.toString()}#${label}`;\n\t\t}\n\t}\n\n\t// In below blob code, we are using JSON.stringify to ensure the passed\n\t// in values are not breaking our script. The values may contain string\n\t// terminating characters (such as ' or \").\n\tconst blob = new Blob([coalesce([\n\t\t`/*${label}*/`,\n\t\t`globalThis._VSCODE_NLS_MESSAGES = ${JSON.stringify(getNLSMessages())};`,\n\t\t`globalThis._VSCODE_NLS_LANGUAGE = ${JSON.stringify(getNLSLanguage())};`,\n\t\t`globalThis._VSCODE_FILE_ROOT = ${JSON.stringify(globalThis._VSCODE_FILE_ROOT)};`,\n\t\t`const ttPolicy = globalThis.trustedTypes?.createPolicy('defaultWorkerFactory', { createScriptURL: value => value });`,\n\t\t`globalThis.workerttPolicy = ttPolicy;`,\n\n\t\tworkerLoadingFailedErrorMessage ? 'try {' : '',\n\t\t`await import(ttPolicy?.createScriptURL(${JSON.stringify(workerScriptUrl)}) ?? ${JSON.stringify(workerScriptUrl)});`,\n\t\tworkerLoadingFailedErrorMessage ? `} catch (err) { console.error(${JSON.stringify(workerLoadingFailedErrorMessage)}, err); throw err; }` : '',\n\n\t\t`globalThis.postMessage({ type: 'vscode-worker-ready' });`,\n\t\t`/*${label}*/`\n\t]).join('')], { type: 'application/javascript' });\n\treturn URL.createObjectURL(blob);\n}\n\nfunction whenESMWorkerReady(worker: Worker): Promise<Worker> {\n\treturn new Promise<Worker>((resolve, reject) => {\n\t\tworker.onmessage = function (e) {\n\t\t\tif (e.data.type === 'vscode-worker-ready') {\n\t\t\t\tworker.onmessage = null;\n\t\t\t\tresolve(worker);\n\t\t\t}\n\t\t};\n\t\tworker.onerror = reject;\n\t});\n}\n\nfunction isPromiseLike<T>(obj: unknown): obj is PromiseLike<T> {\n\treturn !!obj && typeof (obj as PromiseLike<T>).then === 'function';\n}\n\nexport class WebWorker extends Disposable implements IWebWorker {\n\tprivate readonly id: number;\n\tprivate worker: Promise<Worker> | null;\n\n\tprivate readonly _onMessage = this._register(new Emitter<Message>());\n\tpublic readonly onMessage = this._onMessage.event;\n\n\tprivate readonly _onError = this._register(new Emitter<MessageEvent | ErrorEvent>());\n\tpublic readonly onError = this._onError.event;\n\n\tconstructor(worker: Promise<Worker>, id: number) {\n\t\tsuper();\n\t\tthis.id = id;\n\t\tthis.worker = worker;\n\t\tthis.postMessage('-please-ignore-', []); // TODO: Eliminate this extra message\n\t\tconst errorHandler = (ev: ErrorEvent) => {\n\t\t\tthis._onError.fire(ev);\n\t\t};\n\t\tthis.worker.then((w) => {\n\t\t\tw.onmessage = (ev) => {\n\t\t\t\tthis._onMessage.fire(ev.data);\n\t\t\t};\n\t\t\tw.onmessageerror = (ev) => {\n\t\t\t\tthis._onError.fire(ev);\n\t\t\t};\n\t\t\tif (typeof w.addEventListener === 'function') {\n\t\t\t\tw.addEventListener('error', errorHandler);\n\t\t\t}\n\t\t});\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis.worker?.then(w => {\n\t\t\t\tw.onmessage = null;\n\t\t\t\tw.onmessageerror = null;\n\t\t\t\tw.removeEventListener('error', errorHandler);\n\t\t\t\tw.terminate();\n\t\t\t});\n\t\t\tthis.worker = null;\n\t\t}));\n\t}\n\n\tpublic getId(): number {\n\t\treturn this.id;\n\t}\n\n\tpublic postMessage(message: unknown, transfer: Transferable[]): void {\n\t\tthis.worker?.then(w => {\n\t\t\ttry {\n\t\t\t\tw.postMessage(message, transfer);\n\t\t\t} catch (err) {\n\t\t\t\tonUnexpectedError(err);\n\t\t\t\tonUnexpectedError(new Error(`FAILED to post message to worker`, { cause: err }));\n\t\t\t}\n\t\t});\n\t}\n}\n"]}