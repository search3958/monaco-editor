{"version":3,"sources":["file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src/vs/editor/browser/controller/editContext/clipboardUtils.ts","vs/editor/browser/controller/editContext/clipboardUtils.ts"],"names":[],"mappings":"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","file":"clipboardUtils.js","sourceRoot":"file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IViewModel } from '../../../common/viewModel.js';\nimport { Range } from '../../../common/core/range.js';\nimport { isWindows } from '../../../../base/common/platform.js';\nimport { Mimes } from '../../../../base/common/mime.js';\nimport { ViewContext } from '../../../common/viewModel/viewContext.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { EditorOption } from '../../../common/config/editorOptions.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { VSDataTransfer } from '../../../../base/common/dataTransfer.js';\nimport { toExternalVSDataTransfer } from '../../dataTransfer.js';\n\nexport function generateDataToCopyAndStoreInMemory(viewModel: IViewModel, id: string | undefined, isFirefox: boolean): { dataToCopy: ClipboardDataToCopy; metadata: ClipboardStoredMetadata } {\n\tconst { dataToCopy, metadata } = generateDataToCopy(viewModel);\n\tstoreMetadataInMemory(dataToCopy.text, metadata, isFirefox);\n\treturn { dataToCopy, metadata };\n}\n\nfunction storeMetadataInMemory(textToCopy: string, metadata: ClipboardStoredMetadata, isFirefox: boolean): void {\n\tInMemoryClipboardMetadataManager.INSTANCE.set(\n\t\t// When writing \"LINE\\r\\n\" to the clipboard and then pasting,\n\t\t// Firefox pastes \"LINE\\n\", so let's work around this quirk\n\t\t(isFirefox ? textToCopy.replace(/\\r\\n/g, '\\n') : textToCopy),\n\t\tmetadata\n\t);\n}\n\nfunction generateDataToCopy(viewModel: IViewModel): { dataToCopy: ClipboardDataToCopy; metadata: ClipboardStoredMetadata } {\n\tconst emptySelectionClipboard = viewModel.getEditorOption(EditorOption.emptySelectionClipboard);\n\tconst copyWithSyntaxHighlighting = viewModel.getEditorOption(EditorOption.copyWithSyntaxHighlighting);\n\tconst selections = viewModel.getCursorStates().map(cursorState => cursorState.modelState.selection);\n\tconst dataToCopy = getDataToCopy(viewModel, selections, emptySelectionClipboard, copyWithSyntaxHighlighting);\n\tconst metadata: ClipboardStoredMetadata = {\n\t\tversion: 1,\n\t\tid: generateUuid(),\n\t\tisFromEmptySelection: dataToCopy.isFromEmptySelection,\n\t\tmulticursorText: dataToCopy.multicursorText,\n\t\tmode: dataToCopy.mode\n\t};\n\treturn { dataToCopy, metadata };\n}\n\nfunction getDataToCopy(viewModel: IViewModel, modelSelections: Range[], emptySelectionClipboard: boolean, copyWithSyntaxHighlighting: boolean): ClipboardDataToCopy {\n\tconst { sourceRanges, sourceText } = viewModel.getPlainTextToCopy(modelSelections, emptySelectionClipboard, isWindows);\n\tconst newLineCharacter = viewModel.model.getEOL();\n\n\tconst isFromEmptySelection = (emptySelectionClipboard && modelSelections.length === 1 && modelSelections[0].isEmpty());\n\tconst multicursorText = (Array.isArray(sourceText) ? sourceText : null);\n\tconst text = (Array.isArray(sourceText) ? sourceText.join(newLineCharacter) : sourceText);\n\n\tlet html: string | null | undefined = undefined;\n\tlet mode: string | null = null;\n\tif (CopyOptions.forceCopyWithSyntaxHighlighting || (copyWithSyntaxHighlighting && sourceText.length < 65536)) {\n\t\tconst richText = viewModel.getRichTextToCopy(modelSelections, emptySelectionClipboard);\n\t\tif (richText) {\n\t\t\thtml = richText.html;\n\t\t\tmode = richText.mode;\n\t\t}\n\t}\n\tconst dataToCopy: ClipboardDataToCopy = {\n\t\tisFromEmptySelection,\n\t\tsourceRanges,\n\t\tmulticursorText,\n\t\ttext,\n\t\thtml,\n\t\tmode\n\t};\n\treturn dataToCopy;\n}\n\n/**\n * Every time we write to the clipboard, we record a bit of extra metadata here.\n * Every time we read from the cipboard, if the text matches our last written text,\n * we can fetch the previous metadata.\n */\nexport class InMemoryClipboardMetadataManager {\n\tpublic static readonly INSTANCE = new InMemoryClipboardMetadataManager();\n\n\tprivate _lastState: InMemoryClipboardMetadata | null;\n\n\tconstructor() {\n\t\tthis._lastState = null;\n\t}\n\n\tpublic set(lastCopiedValue: string, data: ClipboardStoredMetadata): void {\n\t\tthis._lastState = { lastCopiedValue, data };\n\t}\n\n\tpublic get(pastedText: string): ClipboardStoredMetadata | null {\n\t\tif (this._lastState && this._lastState.lastCopiedValue === pastedText) {\n\t\t\t// match!\n\t\t\treturn this._lastState.data;\n\t\t}\n\t\tthis._lastState = null;\n\t\treturn null;\n\t}\n}\n\nexport interface ClipboardDataToCopy {\n\tisFromEmptySelection: boolean;\n\tsourceRanges: Range[];\n\tmulticursorText: string[] | null | undefined;\n\ttext: string;\n\thtml: string | null | undefined;\n\tmode: string | null;\n}\n\nexport interface ClipboardStoredMetadata {\n\tversion: 1;\n\tid: string | undefined;\n\tisFromEmptySelection: boolean | undefined;\n\tmulticursorText: string[] | null | undefined;\n\tmode: string | null;\n}\n\nexport const CopyOptions = {\n\tforceCopyWithSyntaxHighlighting: false,\n\telectronBugWorkaroundCopyEventHasFired: false\n};\n\ninterface InMemoryClipboardMetadata {\n\tlastCopiedValue: string;\n\tdata: ClipboardStoredMetadata;\n}\n\nconst ClipboardEventUtils = {\n\n\tgetTextData(clipboardData: IReadableClipboardData | DataTransfer): [string, ClipboardStoredMetadata | null] {\n\t\tconst text = clipboardData.getData(Mimes.text);\n\t\tlet metadata: ClipboardStoredMetadata | null = null;\n\t\tconst rawmetadata = clipboardData.getData('vscode-editor-data');\n\t\tif (typeof rawmetadata === 'string') {\n\t\t\ttry {\n\t\t\t\tmetadata = <ClipboardStoredMetadata>JSON.parse(rawmetadata);\n\t\t\t\tif (metadata.version !== 1) {\n\t\t\t\t\tmetadata = null;\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\t// no problem!\n\t\t\t}\n\t\t}\n\t\tif (text.length === 0 && metadata === null && clipboardData.files.length > 0) {\n\t\t\t// no textual data pasted, generate text from file names\n\t\t\tconst files: File[] = Array.prototype.slice.call(clipboardData.files, 0);\n\t\t\treturn [files.map(file => file.name).join('\\n'), null];\n\t\t}\n\t\treturn [text, metadata];\n\t},\n\n\tsetTextData(clipboardData: IWritableClipboardData, text: string, html: string | null | undefined, metadata: ClipboardStoredMetadata): void {\n\t\tclipboardData.setData(Mimes.text, text);\n\t\tif (typeof html === 'string') {\n\t\t\tclipboardData.setData('text/html', html);\n\t\t}\n\t\tclipboardData.setData('vscode-editor-data', JSON.stringify(metadata));\n\t}\n};\n\n/**\n * Readable clipboard data for paste operations.\n */\nexport interface IReadableClipboardData {\n\t/**\n\t * All MIME types present in the clipboard.\n\t */\n\ttypes: string[];\n\n\t/**\n\t * Files from the clipboard (for paste operations).\n\t */\n\treadonly files: readonly File[];\n\n\t/**\n\t * Get data for a specific MIME type.\n\t */\n\tgetData(type: string): string;\n}\n\n/**\n * Writable clipboard data for copy/cut operations.\n */\nexport interface IWritableClipboardData {\n\t/**\n\t * Set data for a specific MIME type.\n\t */\n\tsetData(type: string, value: string): void;\n}\n\n/**\n * Event data for clipboard copy/cut events.\n */\nexport interface IClipboardCopyEvent {\n\t/**\n\t * Whether this is a cut operation.\n\t */\n\treadonly isCut: boolean;\n\n\t/**\n\t * The clipboard data to write to.\n\t */\n\treadonly clipboardData: IWritableClipboardData;\n\n\t/**\n\t * The data to be copied to the clipboard.\n\t */\n\treadonly dataToCopy: ClipboardDataToCopy;\n\n\t/**\n\t * Ensure that the clipboard gets the editor data.\n\t */\n\tensureClipboardGetsEditorData(): void;\n\n\t/**\n\t * Signal that the event has been handled and default processing should be skipped.\n\t */\n\tsetHandled(): void;\n\n\t/**\n\t * Whether the event has been marked as handled.\n\t */\n\treadonly isHandled: boolean;\n}\n\n/**\n * Event data for clipboard paste events.\n */\nexport interface IClipboardPasteEvent {\n\t/**\n\t * The clipboard data being pasted.\n\t */\n\treadonly clipboardData: IReadableClipboardData;\n\n\t/**\n\t * The metadata stored alongside the clipboard data, if any.\n\t */\n\treadonly metadata: ClipboardStoredMetadata | null;\n\n\t/**\n\t * The text content being pasted.\n\t */\n\treadonly text: string;\n\n\t/**\n\t * The underlying DOM event, if available.\n\t * @deprecated Use clipboardData instead. This is provided for backward compatibility.\n\t */\n\treadonly browserEvent: ClipboardEvent | undefined;\n\n\ttoExternalVSDataTransfer(): VSDataTransfer | undefined;\n\n\t/**\n\t * Signal that the event has been handled and default processing should be skipped.\n\t */\n\tsetHandled(): void;\n\n\t/**\n\t * Whether the event has been marked as handled.\n\t */\n\treadonly isHandled: boolean;\n}\n\n/**\n * Creates an IClipboardCopyEvent from a DOM ClipboardEvent.\n */\nexport function createClipboardCopyEvent(e: ClipboardEvent, isCut: boolean, context: ViewContext, logService: ILogService, isFirefox: boolean): IClipboardCopyEvent {\n\tconst { dataToCopy, metadata } = generateDataToCopy(context.viewModel);\n\tlet handled = false;\n\treturn {\n\t\tisCut,\n\t\tclipboardData: {\n\t\t\tsetData: (type: string, value: string) => {\n\t\t\t\te.clipboardData?.setData(type, value);\n\t\t\t},\n\t\t},\n\t\tdataToCopy,\n\t\tensureClipboardGetsEditorData: (): void => {\n\t\t\te.preventDefault();\n\t\t\tif (e.clipboardData) {\n\t\t\t\tClipboardEventUtils.setTextData(e.clipboardData, dataToCopy.text, dataToCopy.html, metadata);\n\t\t\t}\n\t\t\tstoreMetadataInMemory(dataToCopy.text, metadata, isFirefox);\n\t\t\tlogService.trace('ensureClipboardGetsEditorSelection with id : ', metadata.id, ' with text.length: ', dataToCopy.text.length);\n\t\t},\n\t\tsetHandled: () => {\n\t\t\thandled = true;\n\t\t\te.preventDefault();\n\t\t\te.stopImmediatePropagation();\n\t\t},\n\t\tget isHandled() { return handled; },\n\t};\n}\n\n/**\n * Creates an IClipboardPasteEvent from a DOM ClipboardEvent.\n */\nexport function createClipboardPasteEvent(e: ClipboardEvent): IClipboardPasteEvent {\n\tlet handled = false;\n\tlet [text, metadata] = e.clipboardData ? ClipboardEventUtils.getTextData(e.clipboardData) : ['', null];\n\tmetadata = metadata || InMemoryClipboardMetadataManager.INSTANCE.get(text);\n\treturn {\n\t\tclipboardData: createReadableClipboardData(e.clipboardData),\n\t\tmetadata,\n\t\ttext,\n\t\ttoExternalVSDataTransfer: () => e.clipboardData ? toExternalVSDataTransfer(e.clipboardData) : undefined,\n\t\tbrowserEvent: e,\n\t\tsetHandled: () => {\n\t\t\thandled = true;\n\t\t\te.preventDefault();\n\t\t\te.stopImmediatePropagation();\n\t\t},\n\t\tget isHandled() { return handled; },\n\t};\n}\n\nexport function createReadableClipboardData(dataTransfer: DataTransfer | undefined | null): IReadableClipboardData {\n\treturn {\n\t\ttypes: Array.from(dataTransfer?.types ?? []),\n\t\tfiles: Array.prototype.slice.call(dataTransfer?.files ?? [], 0),\n\t\tgetData: (type: string) => dataTransfer?.getData(type) ?? '',\n\t};\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IViewModel } from '../../../common/viewModel.js';\nimport { Range } from '../../../common/core/range.js';\nimport { isWindows } from '../../../../base/common/platform.js';\nimport { Mimes } from '../../../../base/common/mime.js';\nimport { ViewContext } from '../../../common/viewModel/viewContext.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { EditorOption } from '../../../common/config/editorOptions.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { VSDataTransfer } from '../../../../base/common/dataTransfer.js';\nimport { toExternalVSDataTransfer } from '../../dataTransfer.js';\n\nexport function generateDataToCopyAndStoreInMemory(viewModel: IViewModel, id: string | undefined, isFirefox: boolean): { dataToCopy: ClipboardDataToCopy; metadata: ClipboardStoredMetadata } {\n\tconst { dataToCopy, metadata } = generateDataToCopy(viewModel);\n\tstoreMetadataInMemory(dataToCopy.text, metadata, isFirefox);\n\treturn { dataToCopy, metadata };\n}\n\nfunction storeMetadataInMemory(textToCopy: string, metadata: ClipboardStoredMetadata, isFirefox: boolean): void {\n\tInMemoryClipboardMetadataManager.INSTANCE.set(\n\t\t// When writing \"LINE\\r\\n\" to the clipboard and then pasting,\n\t\t// Firefox pastes \"LINE\\n\", so let's work around this quirk\n\t\t(isFirefox ? textToCopy.replace(/\\r\\n/g, '\\n') : textToCopy),\n\t\tmetadata\n\t);\n}\n\nfunction generateDataToCopy(viewModel: IViewModel): { dataToCopy: ClipboardDataToCopy; metadata: ClipboardStoredMetadata } {\n\tconst emptySelectionClipboard = viewModel.getEditorOption(EditorOption.emptySelectionClipboard);\n\tconst copyWithSyntaxHighlighting = viewModel.getEditorOption(EditorOption.copyWithSyntaxHighlighting);\n\tconst selections = viewModel.getCursorStates().map(cursorState => cursorState.modelState.selection);\n\tconst dataToCopy = getDataToCopy(viewModel, selections, emptySelectionClipboard, copyWithSyntaxHighlighting);\n\tconst metadata: ClipboardStoredMetadata = {\n\t\tversion: 1,\n\t\tid: generateUuid(),\n\t\tisFromEmptySelection: dataToCopy.isFromEmptySelection,\n\t\tmulticursorText: dataToCopy.multicursorText,\n\t\tmode: dataToCopy.mode\n\t};\n\treturn { dataToCopy, metadata };\n}\n\nfunction getDataToCopy(viewModel: IViewModel, modelSelections: Range[], emptySelectionClipboard: boolean, copyWithSyntaxHighlighting: boolean): ClipboardDataToCopy {\n\tconst { sourceRanges, sourceText } = viewModel.getPlainTextToCopy(modelSelections, emptySelectionClipboard, isWindows);\n\tconst newLineCharacter = viewModel.model.getEOL();\n\n\tconst isFromEmptySelection = (emptySelectionClipboard && modelSelections.length === 1 && modelSelections[0].isEmpty());\n\tconst multicursorText = (Array.isArray(sourceText) ? sourceText : null);\n\tconst text = (Array.isArray(sourceText) ? sourceText.join(newLineCharacter) : sourceText);\n\n\tlet html: string | null | undefined = undefined;\n\tlet mode: string | null = null;\n\tif (CopyOptions.forceCopyWithSyntaxHighlighting || (copyWithSyntaxHighlighting && sourceText.length < 65536)) {\n\t\tconst richText = viewModel.getRichTextToCopy(modelSelections, emptySelectionClipboard);\n\t\tif (richText) {\n\t\t\thtml = richText.html;\n\t\t\tmode = richText.mode;\n\t\t}\n\t}\n\tconst dataToCopy: ClipboardDataToCopy = {\n\t\tisFromEmptySelection,\n\t\tsourceRanges,\n\t\tmulticursorText,\n\t\ttext,\n\t\thtml,\n\t\tmode\n\t};\n\treturn dataToCopy;\n}\n\n/**\n * Every time we write to the clipboard, we record a bit of extra metadata here.\n * Every time we read from the cipboard, if the text matches our last written text,\n * we can fetch the previous metadata.\n */\nexport class InMemoryClipboardMetadataManager {\n\tpublic static readonly INSTANCE = new InMemoryClipboardMetadataManager();\n\n\tprivate _lastState: InMemoryClipboardMetadata | null;\n\n\tconstructor() {\n\t\tthis._lastState = null;\n\t}\n\n\tpublic set(lastCopiedValue: string, data: ClipboardStoredMetadata): void {\n\t\tthis._lastState = { lastCopiedValue, data };\n\t}\n\n\tpublic get(pastedText: string): ClipboardStoredMetadata | null {\n\t\tif (this._lastState && this._lastState.lastCopiedValue === pastedText) {\n\t\t\t// match!\n\t\t\treturn this._lastState.data;\n\t\t}\n\t\tthis._lastState = null;\n\t\treturn null;\n\t}\n}\n\nexport interface ClipboardDataToCopy {\n\tisFromEmptySelection: boolean;\n\tsourceRanges: Range[];\n\tmulticursorText: string[] | null | undefined;\n\ttext: string;\n\thtml: string | null | undefined;\n\tmode: string | null;\n}\n\nexport interface ClipboardStoredMetadata {\n\tversion: 1;\n\tid: string | undefined;\n\tisFromEmptySelection: boolean | undefined;\n\tmulticursorText: string[] | null | undefined;\n\tmode: string | null;\n}\n\nexport const CopyOptions = {\n\tforceCopyWithSyntaxHighlighting: false,\n\telectronBugWorkaroundCopyEventHasFired: false\n};\n\ninterface InMemoryClipboardMetadata {\n\tlastCopiedValue: string;\n\tdata: ClipboardStoredMetadata;\n}\n\nconst ClipboardEventUtils = {\n\n\tgetTextData(clipboardData: IReadableClipboardData | DataTransfer): [string, ClipboardStoredMetadata | null] {\n\t\tconst text = clipboardData.getData(Mimes.text);\n\t\tlet metadata: ClipboardStoredMetadata | null = null;\n\t\tconst rawmetadata = clipboardData.getData('vscode-editor-data');\n\t\tif (typeof rawmetadata === 'string') {\n\t\t\ttry {\n\t\t\t\tmetadata = <ClipboardStoredMetadata>JSON.parse(rawmetadata);\n\t\t\t\tif (metadata.version !== 1) {\n\t\t\t\t\tmetadata = null;\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\t// no problem!\n\t\t\t}\n\t\t}\n\t\tif (text.length === 0 && metadata === null && clipboardData.files.length > 0) {\n\t\t\t// no textual data pasted, generate text from file names\n\t\t\tconst files: File[] = Array.prototype.slice.call(clipboardData.files, 0);\n\t\t\treturn [files.map(file => file.name).join('\\n'), null];\n\t\t}\n\t\treturn [text, metadata];\n\t},\n\n\tsetTextData(clipboardData: IWritableClipboardData, text: string, html: string | null | undefined, metadata: ClipboardStoredMetadata): void {\n\t\tclipboardData.setData(Mimes.text, text);\n\t\tif (typeof html === 'string') {\n\t\t\tclipboardData.setData('text/html', html);\n\t\t}\n\t\tclipboardData.setData('vscode-editor-data', JSON.stringify(metadata));\n\t}\n};\n\n/**\n * Readable clipboard data for paste operations.\n */\nexport interface IReadableClipboardData {\n\t/**\n\t * All MIME types present in the clipboard.\n\t */\n\ttypes: string[];\n\n\t/**\n\t * Files from the clipboard (for paste operations).\n\t */\n\treadonly files: readonly File[];\n\n\t/**\n\t * Get data for a specific MIME type.\n\t */\n\tgetData(type: string): string;\n}\n\n/**\n * Writable clipboard data for copy/cut operations.\n */\nexport interface IWritableClipboardData {\n\t/**\n\t * Set data for a specific MIME type.\n\t */\n\tsetData(type: string, value: string): void;\n}\n\n/**\n * Event data for clipboard copy/cut events.\n */\nexport interface IClipboardCopyEvent {\n\t/**\n\t * Whether this is a cut operation.\n\t */\n\treadonly isCut: boolean;\n\n\t/**\n\t * The clipboard data to write to.\n\t */\n\treadonly clipboardData: IWritableClipboardData;\n\n\t/**\n\t * The data to be copied to the clipboard.\n\t */\n\treadonly dataToCopy: ClipboardDataToCopy;\n\n\t/**\n\t * Ensure that the clipboard gets the editor data.\n\t */\n\tensureClipboardGetsEditorData(): void;\n\n\t/**\n\t * Signal that the event has been handled and default processing should be skipped.\n\t */\n\tsetHandled(): void;\n\n\t/**\n\t * Whether the event has been marked as handled.\n\t */\n\treadonly isHandled: boolean;\n}\n\n/**\n * Event data for clipboard paste events.\n */\nexport interface IClipboardPasteEvent {\n\t/**\n\t * The clipboard data being pasted.\n\t */\n\treadonly clipboardData: IReadableClipboardData;\n\n\t/**\n\t * The metadata stored alongside the clipboard data, if any.\n\t */\n\treadonly metadata: ClipboardStoredMetadata | null;\n\n\t/**\n\t * The text content being pasted.\n\t */\n\treadonly text: string;\n\n\t/**\n\t * The underlying DOM event, if available.\n\t * @deprecated Use clipboardData instead. This is provided for backward compatibility.\n\t */\n\treadonly browserEvent: ClipboardEvent | undefined;\n\n\ttoExternalVSDataTransfer(): VSDataTransfer | undefined;\n\n\t/**\n\t * Signal that the event has been handled and default processing should be skipped.\n\t */\n\tsetHandled(): void;\n\n\t/**\n\t * Whether the event has been marked as handled.\n\t */\n\treadonly isHandled: boolean;\n}\n\n/**\n * Creates an IClipboardCopyEvent from a DOM ClipboardEvent.\n */\nexport function createClipboardCopyEvent(e: ClipboardEvent, isCut: boolean, context: ViewContext, logService: ILogService, isFirefox: boolean): IClipboardCopyEvent {\n\tconst { dataToCopy, metadata } = generateDataToCopy(context.viewModel);\n\tlet handled = false;\n\treturn {\n\t\tisCut,\n\t\tclipboardData: {\n\t\t\tsetData: (type: string, value: string) => {\n\t\t\t\te.clipboardData?.setData(type, value);\n\t\t\t},\n\t\t},\n\t\tdataToCopy,\n\t\tensureClipboardGetsEditorData: (): void => {\n\t\t\te.preventDefault();\n\t\t\tif (e.clipboardData) {\n\t\t\t\tClipboardEventUtils.setTextData(e.clipboardData, dataToCopy.text, dataToCopy.html, metadata);\n\t\t\t}\n\t\t\tstoreMetadataInMemory(dataToCopy.text, metadata, isFirefox);\n\t\t\tlogService.trace('ensureClipboardGetsEditorSelection with id : ', metadata.id, ' with text.length: ', dataToCopy.text.length);\n\t\t},\n\t\tsetHandled: () => {\n\t\t\thandled = true;\n\t\t\te.preventDefault();\n\t\t\te.stopImmediatePropagation();\n\t\t},\n\t\tget isHandled() { return handled; },\n\t};\n}\n\n/**\n * Creates an IClipboardPasteEvent from a DOM ClipboardEvent.\n */\nexport function createClipboardPasteEvent(e: ClipboardEvent): IClipboardPasteEvent {\n\tlet handled = false;\n\tlet [text, metadata] = e.clipboardData ? ClipboardEventUtils.getTextData(e.clipboardData) : ['', null];\n\tmetadata = metadata || InMemoryClipboardMetadataManager.INSTANCE.get(text);\n\treturn {\n\t\tclipboardData: createReadableClipboardData(e.clipboardData),\n\t\tmetadata,\n\t\ttext,\n\t\ttoExternalVSDataTransfer: () => e.clipboardData ? toExternalVSDataTransfer(e.clipboardData) : undefined,\n\t\tbrowserEvent: e,\n\t\tsetHandled: () => {\n\t\t\thandled = true;\n\t\t\te.preventDefault();\n\t\t\te.stopImmediatePropagation();\n\t\t},\n\t\tget isHandled() { return handled; },\n\t};\n}\n\nexport function createReadableClipboardData(dataTransfer: DataTransfer | undefined | null): IReadableClipboardData {\n\treturn {\n\t\ttypes: Array.from(dataTransfer?.types ?? []),\n\t\tfiles: Array.prototype.slice.call(dataTransfer?.files ?? [], 0),\n\t\tgetData: (type: string) => dataTransfer?.getData(type) ?? '',\n\t};\n}\n"]}