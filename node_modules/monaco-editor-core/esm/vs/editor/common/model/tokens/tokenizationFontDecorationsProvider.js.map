{"version":3,"sources":["file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src/vs/editor/common/model/tokens/tokenizationFontDecorationsProvider.ts","vs/editor/common/model/tokens/tokenizationFontDecorationsProvider.ts"],"names":[],"mappings":"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","file":"tokenizationFontDecorationsProvider.js","sourceRoot":"file:///mnt/vss/_work/1/s/dependencies/vscode/out-editor-src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IModelDecoration, ITextModel } from '../../model.js';\nimport { TokenizationTextModelPart } from './tokenizationTextModelPart.js';\nimport { Range } from '../../core/range.js';\nimport { DecorationProvider, LineFontChangingDecoration, LineHeightChangingDecoration } from '../decorationProvider.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { IFontTokenOption, IModelContentChangedEvent } from '../../textModelEvents.js';\nimport { classNameForFontTokenDecorations } from '../../languages/supports/tokenization.js';\nimport { Position } from '../../core/position.js';\nimport { AnnotatedString, AnnotationsUpdate, IAnnotatedString, IAnnotationUpdate } from './annotations.js';\nimport { OffsetRange } from '../../core/ranges/offsetRange.js';\nimport { offsetEditFromContentChanges } from '../textModelStringEdit.js';\n\nexport interface IFontTokenAnnotation {\n\tdecorationId: string;\n\tfontToken: IFontTokenOption;\n}\n\nexport class TokenizationFontDecorationProvider extends Disposable implements DecorationProvider {\n\n\tprivate static DECORATION_COUNT = 0;\n\n\tprivate readonly _onDidChangeLineHeight = new Emitter<Set<LineHeightChangingDecoration>>();\n\tpublic readonly onDidChangeLineHeight = this._onDidChangeLineHeight.event;\n\n\tprivate readonly _onDidChangeFont = new Emitter<Set<LineFontChangingDecoration>>();\n\tpublic readonly onDidChangeFont = this._onDidChangeFont.event;\n\n\tprivate _fontAnnotatedString: IAnnotatedString<IFontTokenAnnotation> = new AnnotatedString<IFontTokenAnnotation>();\n\n\tconstructor(\n\t\tprivate readonly textModel: ITextModel,\n\t\tprivate readonly tokenizationTextModelPart: TokenizationTextModelPart\n\t) {\n\t\tsuper();\n\t\tthis._register(this.tokenizationTextModelPart.onDidChangeFontTokens(fontChanges => {\n\n\t\t\tconst linesChanged = new Set<number>();\n\t\t\tconst fontTokenAnnotations: IAnnotationUpdate<IFontTokenAnnotation>[] = [];\n\n\t\t\tconst affectedLineHeights = new Set<LineHeightChangingDecoration>();\n\t\t\tconst affectedLineFonts = new Set<LineFontChangingDecoration>();\n\n\t\t\tfor (const annotation of fontChanges.changes.annotations) {\n\n\t\t\t\tconst startPosition = this.textModel.getPositionAt(annotation.range.start);\n\t\t\t\tconst lineNumber = startPosition.lineNumber;\n\n\t\t\t\tlet fontTokenAnnotation: IAnnotationUpdate<IFontTokenAnnotation>;\n\t\t\t\tif (annotation.annotation === undefined) {\n\t\t\t\t\tfontTokenAnnotation = {\n\t\t\t\t\t\trange: annotation.range,\n\t\t\t\t\t\tannotation: undefined\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tconst decorationId = `tokenization-font-decoration-${TokenizationFontDecorationProvider.DECORATION_COUNT}`;\n\t\t\t\t\tconst fontTokenDecoration: IFontTokenAnnotation = {\n\t\t\t\t\t\tfontToken: annotation.annotation,\n\t\t\t\t\t\tdecorationId\n\t\t\t\t\t};\n\t\t\t\t\tfontTokenAnnotation = {\n\t\t\t\t\t\trange: annotation.range,\n\t\t\t\t\t\tannotation: fontTokenDecoration\n\t\t\t\t\t};\n\t\t\t\t\tTokenizationFontDecorationProvider.DECORATION_COUNT++;\n\n\t\t\t\t\tif (annotation.annotation.lineHeightMultiplier) {\n\t\t\t\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, annotation.annotation.lineHeightMultiplier));\n\t\t\t\t\t}\n\t\t\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\n\t\t\t\t}\n\t\t\t\tfontTokenAnnotations.push(fontTokenAnnotation);\n\n\t\t\t\tif (!linesChanged.has(lineNumber)) {\n\t\t\t\t\t// Signal the removal of the font tokenization decorations on the line number\n\t\t\t\t\tconst lineNumberStartOffset = this.textModel.getOffsetAt(new Position(lineNumber, 1));\n\t\t\t\t\tconst lineNumberEndOffset = this.textModel.getOffsetAt(new Position(lineNumber, this.textModel.getLineMaxColumn(lineNumber)));\n\t\t\t\t\tconst lineOffsetRange = new OffsetRange(lineNumberStartOffset, lineNumberEndOffset);\n\t\t\t\t\tconst lineAnnotations = this._fontAnnotatedString.getAnnotationsIntersecting(lineOffsetRange);\n\t\t\t\t\tfor (const annotation of lineAnnotations) {\n\t\t\t\t\t\tconst decorationId = annotation.annotation.decorationId;\n\t\t\t\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, null));\n\t\t\t\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\t\t\t\t\t}\n\t\t\t\t\tlinesChanged.add(lineNumber);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._fontAnnotatedString.setAnnotations(AnnotationsUpdate.create(fontTokenAnnotations));\n\t\t\tthis._onDidChangeLineHeight.fire(affectedLineHeights);\n\t\t\tthis._onDidChangeFont.fire(affectedLineFonts);\n\t\t}));\n\t}\n\n\tpublic handleDidChangeContent(change: IModelContentChangedEvent) {\n\t\tconst edits = offsetEditFromContentChanges(change.changes);\n\t\tconst deletedAnnotations = this._fontAnnotatedString.applyEdit(edits);\n\t\tif (deletedAnnotations.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\t/* We should fire line and font change events if decorations have been added or removed\n\t\t * No decorations are added on edit, but they can be removed */\n\t\tconst affectedLineHeights = new Set<LineHeightChangingDecoration>();\n\t\tconst affectedLineFonts = new Set<LineFontChangingDecoration>();\n\t\tfor (const deletedAnnotation of deletedAnnotations) {\n\t\t\tconst startPosition = this.textModel.getPositionAt(deletedAnnotation.range.start);\n\t\t\tconst lineNumber = startPosition.lineNumber;\n\t\t\tconst decorationId = deletedAnnotation.annotation.decorationId;\n\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, null));\n\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\t\t}\n\t\tthis._onDidChangeLineHeight.fire(affectedLineHeights);\n\t\tthis._onDidChangeFont.fire(affectedLineFonts);\n\t}\n\n\tpublic getDecorationsInRange(range: Range, ownerId?: number, filterOutValidation?: boolean, filterFontDecorations?: boolean, onlyMinimapDecorations?: boolean): IModelDecoration[] {\n\t\tconst startOffsetOfRange = this.textModel.getOffsetAt(range.getStartPosition());\n\t\tconst endOffsetOfRange = this.textModel.getOffsetAt(range.getEndPosition());\n\t\tconst annotations = this._fontAnnotatedString.getAnnotationsIntersecting(new OffsetRange(startOffsetOfRange, endOffsetOfRange));\n\n\t\tconst decorations: IModelDecoration[] = [];\n\t\tfor (const annotation of annotations) {\n\t\t\tconst anno = annotation.annotation;\n\t\t\tconst affectsFont = !!(anno.fontToken.fontFamily || anno.fontToken.fontSizeMultiplier);\n\t\t\tif (!(affectsFont && filterFontDecorations)) {\n\t\t\t\tconst annotationStartPosition = this.textModel.getPositionAt(annotation.range.start);\n\t\t\t\tconst annotationEndPosition = this.textModel.getPositionAt(annotation.range.endExclusive);\n\t\t\t\tconst range = Range.fromPositions(annotationStartPosition, annotationEndPosition);\n\t\t\t\tconst anno = annotation.annotation;\n\t\t\t\tconst className = classNameForFontTokenDecorations(anno.fontToken.fontFamily ?? '', anno.fontToken.fontSizeMultiplier ?? 0);\n\t\t\t\tconst id = anno.decorationId;\n\t\t\t\tdecorations.push({\n\t\t\t\t\tid: id,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tdescription: 'FontOptionDecoration',\n\t\t\t\t\t\tinlineClassName: className,\n\t\t\t\t\t\tlineHeight: anno.fontToken.lineHeightMultiplier,\n\t\t\t\t\t\taffectsFont\n\t\t\t\t\t},\n\t\t\t\t\townerId: 0,\n\t\t\t\t\trange\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn decorations;\n\t}\n\n\tpublic getAllDecorations(ownerId?: number, filterOutValidation?: boolean): IModelDecoration[] {\n\t\treturn this.getDecorationsInRange(\n\t\t\tnew Range(1, 1, this.textModel.getLineCount(), this.textModel.getLineMaxColumn(this.textModel.getLineCount())),\n\t\t\townerId,\n\t\t\tfilterOutValidation\n\t\t);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IModelDecoration, ITextModel } from '../../model.js';\nimport { TokenizationTextModelPart } from './tokenizationTextModelPart.js';\nimport { Range } from '../../core/range.js';\nimport { DecorationProvider, LineFontChangingDecoration, LineHeightChangingDecoration } from '../decorationProvider.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { IFontTokenOption, IModelContentChangedEvent } from '../../textModelEvents.js';\nimport { classNameForFontTokenDecorations } from '../../languages/supports/tokenization.js';\nimport { Position } from '../../core/position.js';\nimport { AnnotatedString, AnnotationsUpdate, IAnnotatedString, IAnnotationUpdate } from './annotations.js';\nimport { OffsetRange } from '../../core/ranges/offsetRange.js';\nimport { offsetEditFromContentChanges } from '../textModelStringEdit.js';\n\nexport interface IFontTokenAnnotation {\n\tdecorationId: string;\n\tfontToken: IFontTokenOption;\n}\n\nexport class TokenizationFontDecorationProvider extends Disposable implements DecorationProvider {\n\n\tprivate static DECORATION_COUNT = 0;\n\n\tprivate readonly _onDidChangeLineHeight = new Emitter<Set<LineHeightChangingDecoration>>();\n\tpublic readonly onDidChangeLineHeight = this._onDidChangeLineHeight.event;\n\n\tprivate readonly _onDidChangeFont = new Emitter<Set<LineFontChangingDecoration>>();\n\tpublic readonly onDidChangeFont = this._onDidChangeFont.event;\n\n\tprivate _fontAnnotatedString: IAnnotatedString<IFontTokenAnnotation> = new AnnotatedString<IFontTokenAnnotation>();\n\n\tconstructor(\n\t\tprivate readonly textModel: ITextModel,\n\t\tprivate readonly tokenizationTextModelPart: TokenizationTextModelPart\n\t) {\n\t\tsuper();\n\t\tthis._register(this.tokenizationTextModelPart.onDidChangeFontTokens(fontChanges => {\n\n\t\t\tconst linesChanged = new Set<number>();\n\t\t\tconst fontTokenAnnotations: IAnnotationUpdate<IFontTokenAnnotation>[] = [];\n\n\t\t\tconst affectedLineHeights = new Set<LineHeightChangingDecoration>();\n\t\t\tconst affectedLineFonts = new Set<LineFontChangingDecoration>();\n\n\t\t\tfor (const annotation of fontChanges.changes.annotations) {\n\n\t\t\t\tconst startPosition = this.textModel.getPositionAt(annotation.range.start);\n\t\t\t\tconst lineNumber = startPosition.lineNumber;\n\n\t\t\t\tlet fontTokenAnnotation: IAnnotationUpdate<IFontTokenAnnotation>;\n\t\t\t\tif (annotation.annotation === undefined) {\n\t\t\t\t\tfontTokenAnnotation = {\n\t\t\t\t\t\trange: annotation.range,\n\t\t\t\t\t\tannotation: undefined\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tconst decorationId = `tokenization-font-decoration-${TokenizationFontDecorationProvider.DECORATION_COUNT}`;\n\t\t\t\t\tconst fontTokenDecoration: IFontTokenAnnotation = {\n\t\t\t\t\t\tfontToken: annotation.annotation,\n\t\t\t\t\t\tdecorationId\n\t\t\t\t\t};\n\t\t\t\t\tfontTokenAnnotation = {\n\t\t\t\t\t\trange: annotation.range,\n\t\t\t\t\t\tannotation: fontTokenDecoration\n\t\t\t\t\t};\n\t\t\t\t\tTokenizationFontDecorationProvider.DECORATION_COUNT++;\n\n\t\t\t\t\tif (annotation.annotation.lineHeightMultiplier) {\n\t\t\t\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, annotation.annotation.lineHeightMultiplier));\n\t\t\t\t\t}\n\t\t\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\n\t\t\t\t}\n\t\t\t\tfontTokenAnnotations.push(fontTokenAnnotation);\n\n\t\t\t\tif (!linesChanged.has(lineNumber)) {\n\t\t\t\t\t// Signal the removal of the font tokenization decorations on the line number\n\t\t\t\t\tconst lineNumberStartOffset = this.textModel.getOffsetAt(new Position(lineNumber, 1));\n\t\t\t\t\tconst lineNumberEndOffset = this.textModel.getOffsetAt(new Position(lineNumber, this.textModel.getLineMaxColumn(lineNumber)));\n\t\t\t\t\tconst lineOffsetRange = new OffsetRange(lineNumberStartOffset, lineNumberEndOffset);\n\t\t\t\t\tconst lineAnnotations = this._fontAnnotatedString.getAnnotationsIntersecting(lineOffsetRange);\n\t\t\t\t\tfor (const annotation of lineAnnotations) {\n\t\t\t\t\t\tconst decorationId = annotation.annotation.decorationId;\n\t\t\t\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, null));\n\t\t\t\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\t\t\t\t\t}\n\t\t\t\t\tlinesChanged.add(lineNumber);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._fontAnnotatedString.setAnnotations(AnnotationsUpdate.create(fontTokenAnnotations));\n\t\t\tthis._onDidChangeLineHeight.fire(affectedLineHeights);\n\t\t\tthis._onDidChangeFont.fire(affectedLineFonts);\n\t\t}));\n\t}\n\n\tpublic handleDidChangeContent(change: IModelContentChangedEvent) {\n\t\tconst edits = offsetEditFromContentChanges(change.changes);\n\t\tconst deletedAnnotations = this._fontAnnotatedString.applyEdit(edits);\n\t\tif (deletedAnnotations.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\t/* We should fire line and font change events if decorations have been added or removed\n\t\t * No decorations are added on edit, but they can be removed */\n\t\tconst affectedLineHeights = new Set<LineHeightChangingDecoration>();\n\t\tconst affectedLineFonts = new Set<LineFontChangingDecoration>();\n\t\tfor (const deletedAnnotation of deletedAnnotations) {\n\t\t\tconst startPosition = this.textModel.getPositionAt(deletedAnnotation.range.start);\n\t\t\tconst lineNumber = startPosition.lineNumber;\n\t\t\tconst decorationId = deletedAnnotation.annotation.decorationId;\n\t\t\taffectedLineHeights.add(new LineHeightChangingDecoration(0, decorationId, lineNumber, null));\n\t\t\taffectedLineFonts.add(new LineFontChangingDecoration(0, decorationId, lineNumber));\n\t\t}\n\t\tthis._onDidChangeLineHeight.fire(affectedLineHeights);\n\t\tthis._onDidChangeFont.fire(affectedLineFonts);\n\t}\n\n\tpublic getDecorationsInRange(range: Range, ownerId?: number, filterOutValidation?: boolean, filterFontDecorations?: boolean, onlyMinimapDecorations?: boolean): IModelDecoration[] {\n\t\tconst startOffsetOfRange = this.textModel.getOffsetAt(range.getStartPosition());\n\t\tconst endOffsetOfRange = this.textModel.getOffsetAt(range.getEndPosition());\n\t\tconst annotations = this._fontAnnotatedString.getAnnotationsIntersecting(new OffsetRange(startOffsetOfRange, endOffsetOfRange));\n\n\t\tconst decorations: IModelDecoration[] = [];\n\t\tfor (const annotation of annotations) {\n\t\t\tconst anno = annotation.annotation;\n\t\t\tconst affectsFont = !!(anno.fontToken.fontFamily || anno.fontToken.fontSizeMultiplier);\n\t\t\tif (!(affectsFont && filterFontDecorations)) {\n\t\t\t\tconst annotationStartPosition = this.textModel.getPositionAt(annotation.range.start);\n\t\t\t\tconst annotationEndPosition = this.textModel.getPositionAt(annotation.range.endExclusive);\n\t\t\t\tconst range = Range.fromPositions(annotationStartPosition, annotationEndPosition);\n\t\t\t\tconst anno = annotation.annotation;\n\t\t\t\tconst className = classNameForFontTokenDecorations(anno.fontToken.fontFamily ?? '', anno.fontToken.fontSizeMultiplier ?? 0);\n\t\t\t\tconst id = anno.decorationId;\n\t\t\t\tdecorations.push({\n\t\t\t\t\tid: id,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tdescription: 'FontOptionDecoration',\n\t\t\t\t\t\tinlineClassName: className,\n\t\t\t\t\t\tlineHeight: anno.fontToken.lineHeightMultiplier,\n\t\t\t\t\t\taffectsFont\n\t\t\t\t\t},\n\t\t\t\t\townerId: 0,\n\t\t\t\t\trange\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn decorations;\n\t}\n\n\tpublic getAllDecorations(ownerId?: number, filterOutValidation?: boolean): IModelDecoration[] {\n\t\treturn this.getDecorationsInRange(\n\t\t\tnew Range(1, 1, this.textModel.getLineCount(), this.textModel.getLineMaxColumn(this.textModel.getLineCount())),\n\t\t\townerId,\n\t\t\tfilterOutValidation\n\t\t);\n\t}\n}\n"]}