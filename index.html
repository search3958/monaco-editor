<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Editor | Baram Code - 登録不要のWebプレビュー環境</title>

	<meta name="description"
		content="URLを開くだけで即座にコーディング開始。HTML/CSS/JSのリアルタイムプレビューに対応した、インストール・ログイン不要の軽量エディタです。作成したコードはローカルに自動保存されます。" />
	<meta name="keywords" content="オンラインエディタ, リアルタイムプレビュー, フロントエンド開発, HTML 練習, ログイン不要, Web Playground, Baram Code" />

	<meta property="og:type" content="article" />
	<meta property="og:title" content="Baram Code Editor - 爆速Webプレイグラウンド" />
	<meta property="og:description" content="環境構築は不要。ブラウザがあなたの開発スタジオになります。今すぐコードを書き始めましょう。" />
	<meta property="og:url" content="https://search3958.github.io/baram/welcome" />
	<meta property="og:image" content="https://search3958.github.io/baram/welcome/og-editor.png" />

	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@your_twitter_id" />
	<script>
		if (window.location.search.includes('id=')) {
			const meta = document.createElement('meta');
			meta.name = 'robots';
			meta.content = 'noindex, nofollow';
			document.head.appendChild(meta);
		}
	</script>
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
	<style>
		@import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap");

		:root {
			color-scheme: light dark;
			--bg: #f6f0e8;
			--bg-ink: #1a1a1a;
			--panel: #fffdf9;
			--panel-strong: #ffffff;
			--border: #e2d9cc;
			--accent: #0b7a75;
			--accent-strong: #08645f;
			--muted: #746a5c;
			--shadow: 0 20px 45px -35px rgba(22, 18, 9, 0.45);
			--bg-gradient: radial-gradient(circle at top left, #fff8ee 0%, #f6f0e8 45%, #efe4d4 100%);
			--topbar-bg: rgba(255, 253, 249, 0.9);
			--button-secondary-bg: #f0e6d6;
			--button-secondary-text: #2a231c;
			--input-bg: #fbf6ef;
			--preview-bg: #ffffff;
			--status-dot: #f4b76f;
			--file-item-bg: #f7f1e7;
			--file-item-text: #3c342a;
			--file-dot: #cbbfae;
			--file-item-active-bg: #e7f4f1;
			--file-item-active-text: #0b7a75;
			--resizer: #d8cdbc;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--bg: #171512;
				--bg-ink: #f2e9dd;
				--panel: #241f1a;
				--panel-strong: #2d2721;
				--border: #3a3229;
				--accent: #4cc9b0;
				--accent-strong: #3bb39e;
				--muted: #b7a997;
				--shadow: 0 24px 50px -40px rgba(0, 0, 0, 0.7);
				--bg-gradient: radial-gradient(circle at top left, #2b241d 0%, #191511 55%, #120f0c 100%);
				--topbar-bg: rgba(27, 24, 20, 0.92);
				--button-secondary-bg: #2c2620;
				--button-secondary-text: #f2e9dd;
				--input-bg: #2a241e;
				--preview-bg: #111111;
				--status-dot: #f0b56c;
				--file-item-bg: #2a241e;
				--file-item-text: #d9cdbf;
				--file-dot: #756a5e;
				--file-item-active-bg: #21413b;
				--file-item-active-text: #8fe2d0;
				--resizer: #3a332b;
			}
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			color: var(--bg-ink);
			font-family: "Space Grotesk", "Noto Sans JP", sans-serif;
			background: var(--bg-gradient);
		}

		.topbar {
			position: sticky;
			top: 0;
			z-index: 5;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 12px 20px;
			gap: 16px;
			background: var(--topbar-bg);
			backdrop-filter: blur(14px);
			border-bottom: 1px solid var(--border);
		}

		.brand {
			display: flex;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap;
		}

		.brand-input {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 6px 12px;
			border-radius: 999px;
			border: 1px solid var(--border);
			background: var(--panel);
		}

		.brand-input span {
			font-size: 0.8rem;
			color: var(--muted);
			text-transform: uppercase;
			letter-spacing: 0.08em;
		}

		.brand-input input {
			border: none;
			background: transparent;
			font-family: "Space Grotesk", "Noto Sans JP", sans-serif;
			font-size: 0.95rem;
			font-weight: 600;
			color: var(--bg-ink);
			width: 200px;
			outline: none;
		}

		.controls {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-items: center;
			justify-content: flex-end;
		}

		.control-group {
			display: flex;
			align-items: center;
			gap: 6px;
			padding: 6px 10px;
			border-radius: 999px;
			border: 1px solid var(--border);
			background: var(--panel);
		}

		.control-group label {
			font-size: 0.85rem;
			color: var(--muted);
		}

		.control-group input[type="checkbox"] {
			accent-color: var(--accent);
			width: 16px;
			height: 16px;
		}

		button {
			border: none;
			border-radius: 999px;
			padding: 8px 14px;
			background: var(--accent);
			color: #fff;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
			box-shadow: 0 10px 20px -12px rgba(11, 122, 117, 0.7);
		}

		button:hover {
			transform: translateY(-1px);
			background: var(--accent-strong);
		}

		button.secondary {
			background: var(--button-secondary-bg);
			color: var(--button-secondary-text);
			box-shadow: none;
			border: 1px solid var(--border);
		}

		button.ghost {
			background: transparent;
			color: var(--muted);
			box-shadow: none;
			border: 1px solid var(--border);
		}

		.segmented {
			display: inline-flex;
			gap: 4px;
			padding: 4px;
			border-radius: 999px;
			border: 1px solid var(--border);
			background: var(--panel);
		}

		.segmented button {
			background: transparent;
			color: var(--muted);
			box-shadow: none;
			padding: 6px 12px;
		}

		.segmented button.is-active {
			background: var(--accent);
			color: #fff;
		}

		.segmented button.is-locked {
			opacity: 0.5;
			pointer-events: none;
		}

		.workspace {
			display: flex;
			gap: 16px;
			padding: 16px 20px 24px;
			height: calc(100vh - 78px);
		}

		.file-panel {
			flex: 0 0 240px;
			max-width: 260px;
			min-width: 200px;
		}

		.workspace.files-collapsed .file-panel {
			display: none;
		}

		.main-pane {
			flex: 1;
			display: flex;
			gap: 16px;
			min-width: 0;
			min-height: 0;
		}

		.workspace.layout-right .main-pane {
			flex-direction: row;
		}

		.workspace.layout-bottom .main-pane {
			flex-direction: column;
		}

		.workspace.layout-hide .preview {
			display: none;
		}

		.panel {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 16px;
			box-shadow: var(--shadow);
			display: flex;
			flex-direction: column;
			overflow: hidden;
			min-height: 0;
		}

		.panel-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 10px;
			padding: 10px 14px;
			border-bottom: 1px solid var(--border);
			background: var(--panel-strong);
			font-size: 0.85rem;
		}

		.panel-header .title {
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.08em;
		}

		.panel-header .input-wrap {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 4px 8px;
			background: var(--input-bg);
		}

		.panel-header .input-wrap span {
			color: var(--muted);
			font-size: 0.74rem;
		}

		.panel-header .input-wrap input {
			border: none;
			background: transparent;
			font-family: "JetBrains Mono", monospace;
			font-size: 0.78rem;
			width: 140px;
			outline: none;
		}

		.editors {
			display: flex;
			gap: 14px;
			min-height: 0;
			flex: 1;
			max-width: calc(100vw - 24px);
		}

		.editors.editors-block {
			flex-direction: column;
		}

		.editors.editors-flex {
			flex-direction: row;
		}

		.editor-panel {
			flex: 1 1 0;
			min-height: 160px;
			min-width: 220px;
		}

		.panel-actions {
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}

		.resize-handle {
			flex: 0 0 auto;
			background: var(--resizer);
			border-radius: 999px;
			opacity: 0.9;
		}

		.editors.editors-block .resize-handle {
			height: 6px;
			cursor: row-resize;
			margin: -4px 6px;
		}

		.editors.editors-flex .resize-handle {
			width: 6px;
			cursor: col-resize;
			margin: 6px -4px;
			align-self: stretch;
		}

		.preview-resize-handle {
			flex: 0 0 auto;
			background: var(--resizer);
			border-radius: 999px;
			opacity: 0.85;
			transition: background 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
			touch-action: none;
		}

		.workspace.layout-right .preview-resize-handle {
			width: 12px;
			cursor: col-resize;
			margin: 6px -6px;
		}

		.workspace.layout-bottom .preview-resize-handle {
			height: 12px;
			cursor: row-resize;
			margin: -6px 6px;
		}

		.workspace.layout-hide .preview-resize-handle {
			display: none;
		}

		.preview-resize-handle:hover,
		.preview-resize-handle.is-dragging {
			background: var(--accent);
			opacity: 1;
			box-shadow: 0 0 0 4px rgba(11, 122, 117, 0.2);
		}

		.editor {
			flex: 1;
			min-height: 0;
		}

		.preview {
			min-height: 0;
			flex: 0.9;
			min-width: 240px;
			min-height: 200px;
		}

		#previewFrame {
			flex: 1;
			width: 100%;
			border: none;
			background: var(--preview-bg);
		}

		.status {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			color: var(--muted);
			font-size: 0.78rem;
		}

		.status .dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--status-dot);
		}

		.file-groups {
			display: flex;
			flex-direction: column;
			gap: 14px;
			padding: 12px 14px 16px;
			overflow: auto;
		}

		.file-group {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.file-group.group-collapsed .file-list {
			display: none;
		}

		.file-group-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 8px;
		}

		.file-group-header button {
			padding: 6px 10px;
			font-size: 0.78rem;
		}

		.file-list {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.file-item {
			display: flex;
			align-items: center;
			gap: 8px;
			justify-content: space-between;
			padding: 8px 10px;
			border-radius: 10px;
			border: 1px solid transparent;
			background: var(--file-item-bg);
			color: var(--file-item-text);
		}

		.file-select {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			flex: 1;
			border: none;
			background: transparent;
			font-family: "JetBrains Mono", monospace;
			font-size: 0.78rem;
			cursor: pointer;
			color: inherit;
			text-align: left;
			padding: 0;
			box-shadow: none;
			border-radius: 0;
		}

		.file-delete {
			border: none;
			background: transparent;
			color: var(--muted);
			padding: 4px 8px;
			border-radius: 999px;
			cursor: pointer;
			box-shadow: none;
		}

		.file-delete:hover {
			background: var(--panel-strong);
			color: var(--bg-ink);
		}

		.file-delete:disabled {
			opacity: 0.45;
			cursor: not-allowed;
		}

		.file-item .file-dot {
			width: 6px;
			height: 6px;
			border-radius: 999px;
			background: var(--file-dot);
		}

		.file-item.is-active {
			border-color: var(--accent);
			background: var(--file-item-active-bg);
			color: var(--file-item-active-text);
		}

		.file-item.is-active .file-dot {
			background: var(--accent);
		}

		.file-item.is-active .file-delete {
			color: var(--file-item-active-text);
		}

		@media (max-width: 1200px) {
			.editors.editors-flex {
				flex-direction: column;
			}

			.editors.editors-flex .resize-handle {
				width: auto;
				height: 6px;
				cursor: row-resize;
				margin: -4px 6px;
				align-self: auto;
			}
		}

		@media (max-width: 1100px) {
			.workspace {
				flex-direction: column;
				height: auto;
			}

			.file-panel {
				max-width: none;
			}

			.main-pane {
				flex-direction: column;
			}

			.preview-resize-handle {
				width: auto;
				height: 12px;
				cursor: row-resize;
				margin: -6px 6px;
			}
		}

		@media (max-width: 720px) {
			.topbar {
				position: static;
				flex-direction: column;
				align-items: stretch;
			}

			.brand-input input {
				width: 160px;
			}
		}
	</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N56NHPY3C"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag() { dataLayer.push(arguments); }
	gtag('js', new Date());

	gtag('config', 'G-7N56NHPY3C');
</script>

<body>
	<header class="topbar">
		<div class="brand">
			<button id="backBtn" class="secondary"><span class="material-symbols-rounded">
					arrow_back
				</span></button>
			<div class="brand-input">
				<input id="projectName" type="text" value="Baram Live Preview" />
			</div>
		</div>
		<div class="controls">
			<div class="control-group">
				<input id="autoUpdate" type="checkbox" checked />
				<label for="autoUpdate">Auto update</label>
			</div>
			<div class="control-group">
				<input id="cssHot" type="checkbox" checked />
				<label for="cssHot">CSS hot reload</label>
			</div>
			<button id="runBtn"><span class="material-symbols-rounded">
					refresh
				</span></button>
			<div class="segmented" id="previewLayout" role="group" aria-label="Preview layout">
				<button class="is-active" data-layout="right"><span class="material-symbols-rounded">
						right_panel_close
					</span></button>
				<button data-layout="bottom"><span class="material-symbols-rounded">
						bottom_panel_close
					</span></button>
				<button data-layout="hide"><span class="material-symbols-rounded">
						ad_off
					</span></button>
			</div>
			<div class="segmented" id="editorLayout" role="group" aria-label="Editor layout">
				<button class="is-active" data-layout="block"><span class="material-symbols-rounded">
						view_agenda
					</span></button>
				<button data-layout="flex"><span class="material-symbols-rounded">
						flex_no_wrap
					</span></button>
			</div>
			<button id="toggleFilesBtn" class="secondary">Hide Files</button>
			<button id="downloadBtn" class="secondary"><span class="material-symbols-rounded">
					download
				</span></button>
			<button id="openTabBtn" class="secondary"><span class="material-symbols-rounded">
					open_in_browser
				</span></button>
		</div>
	</header>

	<main class="workspace layout-right" id="workspace">
		<aside class="panel file-panel" id="filePanel">
			<div class="panel-header">
				<span class="title">Files</span>
				<button id="toggleFilesPanel" class="ghost">Collapse</button>
			</div>
			<div class="file-groups">
				<div class="file-group" data-type="html">
					<div class="file-group-header">
						<button class="ghost group-toggle" data-type="html">HTML</button>
						<button class="ghost add-file" data-type="html">Add</button>
					</div>
					<div class="file-list" id="fileListHtml"></div>
				</div>
				<div class="file-group" data-type="css">
					<div class="file-group-header">
						<button class="ghost group-toggle" data-type="css">CSS</button>
						<button class="ghost add-file" data-type="css">Add</button>
					</div>
					<div class="file-list" id="fileListCss"></div>
				</div>
				<div class="file-group" data-type="js">
					<div class="file-group-header">
						<button class="ghost group-toggle" data-type="js">JS</button>
						<button class="ghost add-file" data-type="js">Add</button>
					</div>
					<div class="file-list" id="fileListJs"></div>
				</div>
			</div>
		</aside>

		<div class="main-pane">
			<section class="editors editors-block" id="editorsPane">
				<div class="panel editor-panel" data-editor="html">
					<div class="panel-header">
						<span class="title">HTML</span>
						<div class="panel-actions">
							<label class="input-wrap">
								<span>file</span>
								<input id="htmlName" type="text" value="index.html" />
							</label>
						</div>
					</div>
					<div class="editor" id="editor-html"></div>
				</div>
				<div class="resize-handle" data-after="html" aria-hidden="true"></div>
				<div class="panel editor-panel" data-editor="css">
					<div class="panel-header">
						<span class="title">CSS</span>
						<div class="panel-actions">
							<label class="input-wrap">
								<span>file</span>
								<input id="cssName" type="text" value="styles.css" />
							</label>
						</div>
					</div>
					<div class="editor" id="editor-css"></div>
				</div>
				<div class="resize-handle" data-after="css" aria-hidden="true"></div>
				<div class="panel editor-panel" data-editor="js">
					<div class="panel-header">
						<span class="title">JS</span>
						<div class="panel-actions">
							<label class="input-wrap">
								<span>file</span>
								<input id="jsName" type="text" value="app.js" />
							</label>
						</div>
					</div>
					<div class="editor" id="editor-js"></div>
				</div>
			</section>

			<div class="preview-resize-handle" id="previewResize" aria-hidden="true"></div>

			<section class="panel preview" id="previewPane">
				<div class="panel-header">
					<span class="title">Preview</span>
					<span class="status" id="previewStatus">
						<span class="dot"></span>
						<span id="statusText">Auto update</span>
					</span>
				</div>
				<iframe id="previewFrame" title="Live preview" sandbox="allow-same-origin allow-scripts"></iframe>
			</section>
		</div>
	</main>

	<script src="./barammodules/monaco-editor/min/vs/loader.js"></script>
	<script>
		const defaultContent = {
			html: `\n<div class="card">\n  <h1>Baram Playground</h1>\n  <p>Edit HTML, CSS, and JS. CSS updates can hot reload without resetting JS.</p>\n  <button class="pulse">Try me</button>\n  <div class="count">Clicks: <span id="count">0</span></div>\n</div>\n`,
			css: `\n* {\n  box-sizing: border-box;\n}\n\nbody {\n  margin: 0;\n  font-family: "Space Grotesk", sans-serif;\n  background: radial-gradient(circle at top, #fff, #f3f1ec 60%);\n  color: #1d1b16;\n  min-height: 100vh;\n  display: grid;\n  place-items: center;\n  padding: 32px;\n}\n\n.card {\n  background: #ffffff;\n  border: 1px solid #e0d7c9;\n  border-radius: 20px;\n  padding: 28px 32px;\n  width: min(520px, 92vw);\n  box-shadow: 0 24px 40px -28px rgba(30, 24, 15, 0.5);\n}\n\n.card h1 {\n  margin-top: 0;\n  font-size: 2.1rem;\n}\n\n.card p {\n  color: #5a5145;\n}\n\n.pulse {\n  margin-top: 16px;\n  border: none;\n  border-radius: 999px;\n  padding: 12px 18px;\n  font-weight: 600;\n  cursor: pointer;\n  background: #0b7a75;\n  color: #fff;\n  box-shadow: 0 16px 30px -20px rgba(11, 122, 117, 0.8);\n  transition: transform 0.2s ease;\n}\n\n.pulse:hover {\n  transform: translateY(-2px);\n}\n\n.count {\n  margin-top: 18px;\n  font-weight: 600;\n}\n`,
			js: `\nconst button = document.querySelector('.pulse');\nconst counter = document.querySelector('#count');\nlet value = 0;\n\nbutton?.addEventListener('click', () => {\n  value += 1;\n  if (counter) counter.textContent = String(value);\n});\n`,
		};

		const DB_KEY = "baram-projects-v1";
		const LEGACY_KEY = "baram-playground";

		function loadDb() {
			try {
				const raw = localStorage.getItem(DB_KEY);
				return raw ? JSON.parse(raw) : { projects: {}, lastProjectId: null };
			} catch (error) {
				return { projects: {}, lastProjectId: null };
			}
		}

		function saveDb(db) {
			localStorage.setItem(DB_KEY, JSON.stringify(db));
		}

		function createId() {
			if (window.crypto?.randomUUID) {
				return window.crypto.randomUUID();
			}
			return `id-${Date.now()}-${Math.random().toString(16).slice(2)}`;
		}

		function createProject(name) {
			const now = new Date().toISOString();
			const htmlFile = { id: createId(), name: "index.html", content: defaultContent.html };
			const cssFile = { id: createId(), name: "styles.css", content: defaultContent.css };
			const jsFile = { id: createId(), name: "app.js", content: defaultContent.js };

			return {
				id: createId(),
				name: name || "Baram Live Preview",
				createdAt: now,
				updatedAt: now,
				files: {
					html: [htmlFile],
					css: [cssFile],
					js: [jsFile],
				},
				active: {
					html: htmlFile.id,
					css: cssFile.id,
					js: jsFile.id,
				},
				settings: {
					autoUpdate: true,
					cssHot: true,
					previewLayout: "right",
					editorLayout: "block",
					filesCollapsed: false,
					groupCollapsed: { html: false, css: false, js: false },
					editorSizes: { block: {}, flex: {} },
					previewSize: { right: null, bottom: null },
				},
			};
		}

		function migrateLegacy(db) {
			if (db && Object.keys(db.projects || {}).length) return db;
			const legacyRaw = localStorage.getItem(LEGACY_KEY);
			if (!legacyRaw) return db;
			try {
				const legacy = JSON.parse(legacyRaw);
				const project = createProject("Baram Live Preview");
				project.files.html[0].content = legacy.html || defaultContent.html;
				project.files.css[0].content = legacy.css || defaultContent.css;
				project.files.js[0].content = legacy.js || defaultContent.js;
				project.files.css[0].name = legacy.cssName || project.files.css[0].name;
				project.files.js[0].name = legacy.jsName || project.files.js[0].name;
				project.settings.autoUpdate = legacy.autoUpdate ?? true;
				project.settings.cssHot = legacy.cssHot ?? true;
				project.settings.previewLayout = legacy.layout || "right";
				db.projects[project.id] = project;
				db.lastProjectId = project.id;
				saveDb(db);
				return db;
			} catch (error) {
				return db;
			}
		}

		function sanitizeText(input, type) {
			if (type === "script") {
				return input.replace(/\<\/script/gi, "<\\/script");
			}
			return input.replace(/\<\/style/gi, "<\\/style");
		}

		const styleClose = "</sty" + "le>";
		const scriptClose = "</scr" + "ipt>";

		function escapeAttribute(input) {
			return input.replace(/&/g, "&amp;").replace(/"/g, "&quot;");
		}

		function ensureActiveFile(project, type) {
			const files = project.files[type];
			if (!files.length) return null;
			if (!files.find((file) => file.id === project.active[type])) {
				project.active[type] = files[0].id;
			}
			return files.find((file) => file.id === project.active[type]);
		}

		function ensureEditorSettings(project) {
			project.settings = project.settings || {};
			project.settings.editorSizes = project.settings.editorSizes || { block: {}, flex: {} };
			project.settings.previewSize = project.settings.previewSize || { right: null, bottom: null };
		}

		const db = migrateLegacy(loadDb());
		const params = new URLSearchParams(window.location.search);
		let projectId = params.get("id") || db.lastProjectId;
		let project = projectId ? db.projects[projectId] : null;

		if (!project) {
			project = createProject("Baram Live Preview");
			db.projects[project.id] = project;
			projectId = project.id;
		}

		db.lastProjectId = project.id;
		saveDb(db);

		if (project.id !== params.get("id")) {
			params.set("id", project.id);
			const nextUrl = `${window.location.pathname}?${params.toString()}`;
			window.history.replaceState({}, "", nextUrl);
		}

		ensureActiveFile(project, "html");
		ensureActiveFile(project, "css");
		ensureActiveFile(project, "js");
		ensureEditorSettings(project);

		const projectNameInput = document.getElementById("projectName");
		const autoUpdateInput = document.getElementById("autoUpdate");
		const cssHotInput = document.getElementById("cssHot");
		const runBtn = document.getElementById("runBtn");
		const openTabBtn = document.getElementById("openTabBtn");
		const downloadBtn = document.getElementById("downloadBtn");
		const backBtn = document.getElementById("backBtn");
		const previewFrame = document.getElementById("previewFrame");
		const previewStatus = document.getElementById("statusText");
		const workspace = document.getElementById("workspace");
		const editorsPane = document.getElementById("editorsPane");
		const previewPane = document.getElementById("previewPane");
		const previewResize = document.getElementById("previewResize");
		const mainPane = document.querySelector(".main-pane");
		const toggleFilesBtn = document.getElementById("toggleFilesBtn");
		const toggleFilesPanelBtn = document.getElementById("toggleFilesPanel");
		const htmlNameInput = document.getElementById("htmlName");
		const cssNameInput = document.getElementById("cssName");
		const jsNameInput = document.getElementById("jsName");
		const editorOrder = ["html", "css", "js"];
		const editorPanels = {
			html: document.querySelector('.editor-panel[data-editor="html"]'),
			css: document.querySelector('.editor-panel[data-editor="css"]'),
			js: document.querySelector('.editor-panel[data-editor="js"]'),
		};

		const previewLayoutButtons = Array.from(document.querySelectorAll("#previewLayout button"));
		const editorLayoutButtons = Array.from(document.querySelectorAll("#editorLayout button"));
		const resizeHandles = Array.from(document.querySelectorAll(".resize-handle"));
		const groupToggles = Array.from(document.querySelectorAll(".group-toggle"));
		const addFileButtons = Array.from(document.querySelectorAll(".add-file"));

		const fileLists = {
			html: document.getElementById("fileListHtml"),
			css: document.getElementById("fileListCss"),
			js: document.getElementById("fileListJs"),
		};

		projectNameInput.value = project.name || "Baram Live Preview";
		document.title = projectNameInput.value;

		autoUpdateInput.checked = project.settings?.autoUpdate ?? true;
		cssHotInput.checked = project.settings?.cssHot ?? true;

		let previewWindow = null;
		let changePending = false;
		let cssPending = false;
		let isSwitching = false;
		const themeMedia = window.matchMedia("(prefers-color-scheme: dark)");

		function saveProject() {
			project.updatedAt = new Date().toISOString();
			db.projects[project.id] = project;
			db.lastProjectId = project.id;
			saveDb(db);
		}

		function scheduleSave() {
			if (scheduleSave.timer) clearTimeout(scheduleSave.timer);
			scheduleSave.timer = setTimeout(saveProject, 300);
		}

		function updateStatus() {
			if (workspace.classList.contains("layout-hide")) {
				previewStatus.textContent = "Preview hidden";
				return;
			}
			if (autoUpdateInput.checked) {
				previewStatus.textContent = "Auto update";
			} else if (changePending) {
				previewStatus.textContent = "Manual update needed";
			} else {
				previewStatus.textContent = "Manual mode";
			}
		}

		function buildDocument() {
			const htmlFile = ensureActiveFile(project, "html");
			const html = htmlFile ? htmlFile.content : "";

			const cssBlocks = project.files.css
				.map((file) => {
					const css = sanitizeText(file.content || "", "style");
					return `<style data-file-id="${file.id}" data-filename="${escapeAttribute(file.name)}">${css}${styleClose}`;
				})
				.join("\n");

			const jsBlocks = project.files.js
				.map((file) => {
					const js = sanitizeText(file.content || "", "script");
					return `<script data-file-id="${file.id}" data-filename="${escapeAttribute(file.name)}">${js}${scriptClose}`;
				})
				.join("\n");

			return [
				"\<!doctype html\>",
				"\<html lang=\"en\"\>",
				"  <head>",
				"    \<meta charset=\"utf-8\" \/\>",
				"    \<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" \/\>",
				"    \<title\>Preview\<\/title\>",
				`    ${cssBlocks}`,
				"  \<\/head\>",
				"  \<body\>",
				html,
				`    ${jsBlocks}`,
				"  \<\/body\>",
				"\<\/html\>",
			].join("\n");
		}

		function renderPreview() {
			const doc = buildDocument();
			previewFrame.srcdoc = doc;
			if (previewWindow && !previewWindow.closed) {
				previewWindow.document.open();
				previewWindow.document.write(doc);
				previewWindow.document.close();
			}
			changePending = false;
			updateStatus();
		}

		function updateCssOnly(fileId) {
			const file = project.files.css.find((item) => item.id === fileId);
			if (!file) return;

			const updateDoc = (doc) => {
				if (!doc) return;
				const styleTag = doc.querySelector(`style[data-file-id="${fileId}"]`);
				if (styleTag) {
					styleTag.textContent = file.content;
					styleTag.setAttribute("data-filename", file.name);
				}
			};

			updateDoc(previewFrame.contentDocument);
			if (previewWindow && !previewWindow.closed) {
				updateDoc(previewWindow.document);
			}
		}

		function schedulePreviewUpdate() {
			changePending = true;
			updateStatus();
			if (!autoUpdateInput.checked) return;
			if (schedulePreviewUpdate.timer) clearTimeout(schedulePreviewUpdate.timer);
			schedulePreviewUpdate.timer = setTimeout(renderPreview, 250);
		}

		function scheduleCssUpdate(fileId) {
			cssPending = true;
			if (!cssHotInput.checked) return;
			if (scheduleCssUpdate.timer) clearTimeout(scheduleCssUpdate.timer);
			scheduleCssUpdate.timer = setTimeout(() => {
				updateCssOnly(fileId);
				cssPending = false;
			}, 120);
		}

		function updatePreviewLayoutButtons(layout) {
			previewLayoutButtons.forEach((btn) => {
				btn.classList.toggle("is-active", btn.dataset.layout === layout);
			});
		}

		function updateEditorLayoutLock() {
			const lock = getActivePreviewLayout() !== "hide";
			editorLayoutButtons.forEach((btn) => {
				btn.classList.toggle("is-locked", lock);
				btn.disabled = lock;
				btn.setAttribute("aria-disabled", lock ? "true" : "false");
			});
		}

		function getForcedEditorLayout(previewLayout) {
			if (previewLayout === "right") return "block";
			if (previewLayout === "bottom") return "flex";
			return null;
		}

		function applyEditorLayout(layout) {
			editorsPane.classList.toggle("editors-block", layout === "block");
			editorsPane.classList.toggle("editors-flex", layout === "flex");
			editorLayoutButtons.forEach((btn) => {
				btn.classList.toggle("is-active", btn.dataset.layout === layout);
			});
			applyEditorSizes();
			updateResizeHandles();
		}

		function setPreviewLayout(layout) {
			workspace.classList.toggle("layout-right", layout === "right");
			workspace.classList.toggle("layout-bottom", layout === "bottom");
			workspace.classList.toggle("layout-hide", layout === "hide");
			updatePreviewLayoutButtons(layout);
			project.settings.previewLayout = layout;
			updateStatus();
			const forcedLayout = getForcedEditorLayout(layout);
			if (forcedLayout) {
				applyEditorLayout(forcedLayout);
			} else {
				applyEditorLayout(project.settings.editorLayout || "block");
			}
			applyPreviewSize();
			updateEditorLayoutLock();
			scheduleSave();
		}

		function getActivePreviewLayout() {
			if (workspace.classList.contains("layout-hide")) return "hide";
			if (workspace.classList.contains("layout-bottom")) return "bottom";
			return "right";
		}

		function applyPreviewSize() {
			if (!previewPane) return;
			const layout = getActivePreviewLayout();
			if (layout === "hide") {
				previewPane.style.flexBasis = "";
				return;
			}
			const size = project.settings.previewSize?.[layout];
			previewPane.style.flexBasis = size ? `${size}px` : "";
		}

		function savePreviewSize(size) {
			const layout = getActivePreviewLayout();
			if (layout === "hide") return;
			project.settings.previewSize = project.settings.previewSize || { right: null, bottom: null };
			project.settings.previewSize[layout] = size;
			scheduleSave();
		}

		function startPreviewResize(event) {
			if (!previewPane || !mainPane) return;
			const layout = getActivePreviewLayout();
			if (layout === "hide") return;
			const axis = layout === "bottom" ? "y" : "x";
			const handle = event.currentTarget;
			const startPoint = axis === "x" ? event.clientX : event.clientY;
			const previewRect = previewPane.getBoundingClientRect();
			const mainRect = mainPane.getBoundingClientRect();
			const startPreview = axis === "x" ? previewRect.width : previewRect.height;
			const total = axis === "x" ? mainRect.width : mainRect.height;
			const minPreview = 220;
			const minEditors = 280;

			if (previewResize) previewResize.classList.add("is-dragging");
			const previousPointerEvents = previewFrame?.style.pointerEvents || "";
			if (previewFrame) previewFrame.style.pointerEvents = "none";
			if (handle?.setPointerCapture && event.pointerId !== undefined) {
				handle.setPointerCapture(event.pointerId);
			}

			function onMove(moveEvent) {
				const current = axis === "x" ? moveEvent.clientX : moveEvent.clientY;
				const delta = current - startPoint;
				let next = startPreview - delta;
				const maxPreview = total - minEditors;
				next = Math.max(minPreview, Math.min(maxPreview, next));
				previewPane.style.flexBasis = `${Math.round(next)}px`;
			}

			function onUp() {
				document.body.style.cursor = "";
				window.removeEventListener("pointermove", onMove);
				window.removeEventListener("pointerup", onUp);
				window.removeEventListener("pointercancel", onUp);
				window.removeEventListener("blur", onUp);
				if (previewResize) previewResize.classList.remove("is-dragging");
				if (previewFrame) previewFrame.style.pointerEvents = previousPointerEvents;
				if (handle?.releasePointerCapture && event.pointerId !== undefined) {
					try {
						handle.releasePointerCapture(event.pointerId);
					} catch (error) {
						// Ignore if capture was lost.
					}
				}
				const rect = previewPane.getBoundingClientRect();
				const finalSize = axis === "x" ? rect.width : rect.height;
				savePreviewSize(Math.round(finalSize));
			}

			document.body.style.cursor = axis === "x" ? "col-resize" : "row-resize";
			window.addEventListener("pointermove", onMove);
			window.addEventListener("pointerup", onUp);
			window.addEventListener("pointercancel", onUp);
			window.addEventListener("blur", onUp);
		}

		function setEditorLayout(layout) {
			if (getActivePreviewLayout() !== "hide") return;
			applyEditorLayout(layout);
			project.settings.editorLayout = layout;
			scheduleSave();
		}

		function getEditorDirection() {
			return window.getComputedStyle(editorsPane).flexDirection;
		}

		function applyEditorSizes() {
			const layout = editorsPane.classList.contains("editors-flex") ? "flex" : "block";
			const direction = getEditorDirection();
			const allow = layout === "flex" ? direction === "row" : true;
			const sizes = project.settings.editorSizes?.[layout] || {};
			editorOrder.forEach((type) => {
				const panel = editorPanels[type];
				if (!panel) return;
				if (!allow) {
					panel.style.flexBasis = "";
					return;
				}
				if (sizes[type]) {
					panel.style.flexBasis = `${sizes[type]}px`;
				} else {
					panel.style.flexBasis = "";
				}
			});
		}

		function captureEditorSizes() {
			const layout = editorsPane.classList.contains("editors-flex") ? "flex" : "block";
			const direction = getEditorDirection();
			const allow = layout === "flex" ? direction === "row" : true;
			if (!allow) return;
			const sizes = project.settings.editorSizes?.[layout] || {};
			editorOrder.forEach((type) => {
				const panel = editorPanels[type];
				if (!panel) return;
				const rect = panel.getBoundingClientRect();
				const value = direction === "row" ? rect.width : rect.height;
				sizes[type] = Math.max(120, Math.round(value));
			});
			project.settings.editorSizes = project.settings.editorSizes || { block: {}, flex: {} };
			project.settings.editorSizes[layout] = sizes;
			scheduleSave();
		}

		function updateResizeHandles() {
			const direction = getEditorDirection();
			const hideForDirection = editorsPane.classList.contains("editors-flex") && direction === "column";
			resizeHandles.forEach((handle) => {
				const prevKey = handle.dataset.after;
				const prevIndex = editorOrder.indexOf(prevKey);
				const nextKey = editorOrder[prevIndex + 1];
				const prevPanel = editorPanels[prevKey];
				const nextPanel = editorPanels[nextKey];
				if (!prevPanel || !nextPanel) return;
				handle.style.display = hideForDirection ? "none" : "";
			});
		}

		function startResize(handle, event) {
			const layout = editorsPane.classList.contains("editors-flex") ? "flex" : "block";
			const direction = getEditorDirection();
			const axis = direction === "row" ? "x" : "y";
			if (layout === "flex" && direction === "column") return;
			const prevKey = handle.dataset.after;
			const prevIndex = editorOrder.indexOf(prevKey);
			const nextKey = editorOrder[prevIndex + 1];
			const prevPanel = editorPanels[prevKey];
			const nextPanel = editorPanels[nextKey];
			if (!prevPanel || !nextPanel) return;

			const startPoint = axis === "x" ? event.clientX : event.clientY;
			const prevRect = prevPanel.getBoundingClientRect();
			const nextRect = nextPanel.getBoundingClientRect();
			const startPrev = axis === "x" ? prevRect.width : prevRect.height;
			const startNext = axis === "x" ? nextRect.width : nextRect.height;
			const minSize = 140;

			function onMove(moveEvent) {
				const current = axis === "x" ? moveEvent.clientX : moveEvent.clientY;
				const delta = current - startPoint;
				const nextPrev = startPrev + delta;
				const nextNext = startNext - delta;
				if (nextPrev < minSize || nextNext < minSize) return;
				prevPanel.style.flexBasis = `${nextPrev}px`;
				nextPanel.style.flexBasis = `${nextNext}px`;
			}

			function onUp() {
				document.body.style.cursor = "";
				window.removeEventListener("pointermove", onMove);
				window.removeEventListener("pointerup", onUp);
				captureEditorSizes();
			}

			document.body.style.cursor = axis === "x" ? "col-resize" : "row-resize";
			window.addEventListener("pointermove", onMove);
			window.addEventListener("pointerup", onUp);
		}

		function setFilesCollapsed(collapsed) {
			workspace.classList.toggle("files-collapsed", collapsed);
			if (toggleFilesBtn) {
				toggleFilesBtn.textContent = collapsed ? "Show Files" : "Hide Files";
			}
			if (toggleFilesPanelBtn) {
				toggleFilesPanelBtn.textContent = collapsed ? "Expand" : "Collapse";
			}
			project.settings.filesCollapsed = collapsed;
			scheduleSave();
		}

		function setGroupCollapsed(type, collapsed) {
			const group = document.querySelector(`.file-group[data-type="${type}"]`);
			if (!group) return;
			group.classList.toggle("group-collapsed", collapsed);
			project.settings.groupCollapsed[type] = collapsed;
			scheduleSave();
		}

		function getActiveFile(type) {
			return ensureActiveFile(project, type);
		}

		function saveActiveFile(type) {
			const file = getActiveFile(type);
			if (!file) return;
			if (type === "html") file.content = htmlEditor.getValue();
			if (type === "css") file.content = cssEditor.getValue();
			if (type === "js") file.content = jsEditor.getValue();
		}

		function setActiveFile(type, id) {
			if (project.active[type] === id) return;
			saveActiveFile(type);
			project.active[type] = id;
			const file = getActiveFile(type);
			if (!file) return;
			isSwitching = true;
			if (type === "html") htmlEditor.setValue(file.content || "");
			if (type === "css") cssEditor.setValue(file.content || "");
			if (type === "js") jsEditor.setValue(file.content || "");
			isSwitching = false;
			updateFileNameInputs();
			renderFileList(type);
			schedulePreviewUpdate();
			scheduleSave();
		}

		function makeUniqueName(type, name, ignoreId) {
			const cleaned = name.trim();
			if (!cleaned) return name;
			const existing = project.files[type]
				.filter((file) => file.id !== ignoreId)
				.map((file) => file.name.toLowerCase());
			if (!existing.includes(cleaned.toLowerCase())) return cleaned;

			const parts = cleaned.split(".");
			const ext = parts.length > 1 ? parts.pop() : "";
			const base = parts.join(".");
			let index = 2;
			let candidate = ext ? `${base}-${index}.${ext}` : `${base}-${index}`;
			while (existing.includes(candidate.toLowerCase())) {
				index += 1;
				candidate = ext ? `${base}-${index}.${ext}` : `${base}-${index}`;
			}
			return candidate;
		}

		function renameActiveFile(type, nextName) {
			const file = getActiveFile(type);
			if (!file) return;
			const trimmed = nextName.trim();
			if (!trimmed) {
				updateFileNameInputs();
				return;
			}
			const unique = makeUniqueName(type, trimmed, file.id);
			file.name = unique;
			updateFileNameInputs();
			renderFileList(type);
			schedulePreviewUpdate();
			scheduleSave();
		}

		function updateFileNameInputs() {
			const htmlFile = getActiveFile("html");
			const cssFile = getActiveFile("css");
			const jsFile = getActiveFile("js");
			if (htmlFile) htmlNameInput.value = htmlFile.name;
			if (cssFile) cssNameInput.value = cssFile.name;
			if (jsFile) jsNameInput.value = jsFile.name;
		}

		function canDeleteFile(type) {
			return project.files[type].length > 1;
		}

		function deleteFile(type, id) {
			if (!canDeleteFile(type)) return;
			const fileIndex = project.files[type].findIndex((file) => file.id === id);
			if (fileIndex === -1) return;
			const target = project.files[type][fileIndex];
			const ok = window.confirm(`Delete ${target.name}?`);
			if (!ok) return;
			project.files[type].splice(fileIndex, 1);
			if (project.active[type] === id) {
				const nextFile = project.files[type][Math.max(0, fileIndex - 1)] || project.files[type][0];
				project.active[type] = nextFile.id;
				isSwitching = true;
				if (type === "html") htmlEditor.setValue(nextFile.content || "");
				if (type === "css") cssEditor.setValue(nextFile.content || "");
				if (type === "js") jsEditor.setValue(nextFile.content || "");
				isSwitching = false;
			}
			renderFileList(type);
			updateFileNameInputs();
			schedulePreviewUpdate();
			scheduleSave();
		}

		function renderFileList(type) {
			const list = fileLists[type];
			if (!list) return;
			list.innerHTML = "";
			const allowDelete = canDeleteFile(type);
			project.files[type].forEach((file) => {
				const item = document.createElement("div");
				item.className = `file-item${file.id === project.active[type] ? " is-active" : ""}`;

				const selectBtn = document.createElement("button");
				selectBtn.className = "file-select";
				selectBtn.type = "button";
				selectBtn.innerHTML = `<span class="file-dot"></span><span class="file-name"></span>`;
				selectBtn.querySelector(".file-name").textContent = file.name;
				selectBtn.addEventListener("click", () => setActiveFile(type, file.id));

				const deleteBtn = document.createElement("button");
				deleteBtn.className = "file-delete";
				deleteBtn.type = "button";
				deleteBtn.textContent = "×";
				deleteBtn.disabled = !allowDelete;
				deleteBtn.title = allowDelete ? "Delete file" : "At least one file is required";
				deleteBtn.addEventListener("click", (event) => {
					event.stopPropagation();
					deleteFile(type, file.id);
				});

				item.appendChild(selectBtn);
				item.appendChild(deleteBtn);
				list.appendChild(item);
			});
		}

		function renderAllFileLists() {
			renderFileList("html");
			renderFileList("css");
			renderFileList("js");
		}

		function addFile(type) {
			const baseName =
				type === "html" ? "page.html" : type === "css" ? "styles.css" : "script.js";
			const uniqueName = makeUniqueName(type, baseName);
			const file = {
				id: createId(),
				name: uniqueName,
				content: "\n",
			};
			project.files[type].push(file);
			project.active[type] = file.id;
			renderFileList(type);
			setActiveFile(type, file.id);
			scheduleSave();
		}

		function sanitizeFileName(name) {
			return name.replace(/[^a-z0-9\-_]+/gi, "-").replace(/^-+|-+$/g, "") || "project";
		}

		function getDosTime(date) {
			return (date.getHours() << 11) | (date.getMinutes() << 5) | Math.floor(date.getSeconds() / 2);
		}

		function getDosDate(date) {
			return ((date.getFullYear() - 1980) << 9) | ((date.getMonth() + 1) << 5) | date.getDate();
		}

		const crcTable = (() => {
			const table = new Uint32Array(256);
			for (let i = 0; i < 256; i += 1) {
				let value = i;
				for (let j = 0; j < 8; j += 1) {
					value = value & 1 ? 0xedb88320 ^ (value >>> 1) : value >>> 1;
				}
				table[i] = value >>> 0;
			}
			return table;
		})();

		function crc32(buffer) {
			let crc = 0xffffffff;
			for (let i = 0; i < buffer.length; i += 1) {
				crc = (crc >>> 8) ^ crcTable[(crc ^ buffer[i]) & 0xff];
			}
			return (crc ^ 0xffffffff) >>> 0;
		}

		function createZipBlob(entries) {
			const encoder = new TextEncoder();
			const date = new Date();
			const dosTime = getDosTime(date);
			const dosDate = getDosDate(date);

			let offset = 0;
			const localParts = [];
			const centralParts = [];

			entries.forEach((entry) => {
				const nameBytes = encoder.encode(entry.name);
				const dataBytes = encoder.encode(entry.content || "");
				const crc = crc32(dataBytes);

				const localHeader = new Uint8Array(30 + nameBytes.length);
				const localView = new DataView(localHeader.buffer);
				localView.setUint32(0, 0x04034b50, true);
				localView.setUint16(4, 20, true);
				localView.setUint16(6, 0, true);
				localView.setUint16(8, 0, true);
				localView.setUint16(10, dosTime, true);
				localView.setUint16(12, dosDate, true);
				localView.setUint32(14, crc, true);
				localView.setUint32(18, dataBytes.length, true);
				localView.setUint32(22, dataBytes.length, true);
				localView.setUint16(26, nameBytes.length, true);
				localView.setUint16(28, 0, true);
				localHeader.set(nameBytes, 30);

				localParts.push(localHeader, dataBytes);

				const centralHeader = new Uint8Array(46 + nameBytes.length);
				const centralView = new DataView(centralHeader.buffer);
				centralView.setUint32(0, 0x02014b50, true);
				centralView.setUint16(4, 20, true);
				centralView.setUint16(6, 20, true);
				centralView.setUint16(8, 0, true);
				centralView.setUint16(10, 0, true);
				centralView.setUint16(12, dosTime, true);
				centralView.setUint16(14, dosDate, true);
				centralView.setUint32(16, crc, true);
				centralView.setUint32(20, dataBytes.length, true);
				centralView.setUint32(24, dataBytes.length, true);
				centralView.setUint16(28, nameBytes.length, true);
				centralView.setUint16(30, 0, true);
				centralView.setUint16(32, 0, true);
				centralView.setUint16(34, 0, true);
				centralView.setUint16(36, 0, true);
				centralView.setUint32(38, 0, true);
				centralView.setUint32(42, offset, true);
				centralHeader.set(nameBytes, 46);
				centralParts.push(centralHeader);

				offset += localHeader.length + dataBytes.length;
			});

			const centralSize = centralParts.reduce((sum, part) => sum + part.length, 0);
			const centralOffset = offset;

			const endRecord = new Uint8Array(22);
			const endView = new DataView(endRecord.buffer);
			endView.setUint32(0, 0x06054b50, true);
			endView.setUint16(4, 0, true);
			endView.setUint16(6, 0, true);
			endView.setUint16(8, entries.length, true);
			endView.setUint16(10, entries.length, true);
			endView.setUint32(12, centralSize, true);
			endView.setUint32(16, centralOffset, true);
			endView.setUint16(20, 0, true);

			return new Blob([...localParts, ...centralParts, endRecord], { type: "application/zip" });
		}

		function downloadZip() {
			const files = [
				...project.files.html,
				...project.files.css,
				...project.files.js,
			].map((file) => ({ name: file.name, content: file.content }));

			const blob = createZipBlob(files);
			const link = document.createElement("a");
			link.href = URL.createObjectURL(blob);
			link.download = `${sanitizeFileName(project.name)}.zip`;
			document.body.appendChild(link);
			link.click();
			link.remove();
			setTimeout(() => URL.revokeObjectURL(link.href), 1000);
		}

		let htmlEditor;
		let cssEditor;
		let jsEditor;

		window.require.config({ paths: { vs: "/barammodules/monaco-editor/min/vs" } });
		window.require(["vs/editor/baram-editor-main"], () => {
			monaco.editor.defineTheme("baramLight", {
				base: "vs",
				inherit: true,
				rules: [
					{ token: "comment", foreground: "8a7f72" },
					{ token: "keyword", foreground: "0b7a75" },
					{ token: "string", foreground: "7b5a3b" },
				],
				colors: {
					"editor.background": "#fffdf9",
					"editorLineNumber.foreground": "#b3a99b",
					"editor.lineHighlightBackground": "#f7f2ea",
					"editor.selectionBackground": "#d3efe8",
				},
			});

			monaco.editor.defineTheme("baramDark", {
				base: "vs-dark",
				inherit: true,
				rules: [
					{ token: "comment", foreground: "8f867a" },
					{ token: "keyword", foreground: "4cc9b0" },
					{ token: "string", foreground: "d0a875" },
				],
				colors: {
					"editor.background": "#1b1712",
					"editorLineNumber.foreground": "#6f6558",
					"editor.lineHighlightBackground": "#242019",
					"editor.selectionBackground": "#2b4c46",
				},
			});

			const common = {
				theme: themeMedia.matches ? "baramDark" : "baramLight",
				fontFamily: "JetBrains Mono, ui-monospace, monospace",
				fontSize: 13,
				minimap: { enabled: false },
				automaticLayout: true,
				scrollBeyondLastLine: false,
			};

			const htmlFile = getActiveFile("html");
			const cssFile = getActiveFile("css");
			const jsFile = getActiveFile("js");

			htmlEditor = monaco.editor.create(document.getElementById("editor-html"), {
				value: htmlFile?.content || "",
				language: "html",
				...common,
			});

			cssEditor = monaco.editor.create(document.getElementById("editor-css"), {
				value: cssFile?.content || "",
				language: "css",
				...common,
			});

			jsEditor = monaco.editor.create(document.getElementById("editor-js"), {
				value: jsFile?.content || "",
				language: "javascript",
				...common,
			});

			htmlEditor.onDidChangeModelContent(() => {
				if (isSwitching) return;
				const file = getActiveFile("html");
				if (file) file.content = htmlEditor.getValue();
				schedulePreviewUpdate();
				scheduleSave();
			});

			cssEditor.onDidChangeModelContent(() => {
				if (isSwitching) return;
				const file = getActiveFile("css");
				if (file) file.content = cssEditor.getValue();
				scheduleCssUpdate(project.active.css);
				schedulePreviewUpdate();
				scheduleSave();
			});

			jsEditor.onDidChangeModelContent(() => {
				if (isSwitching) return;
				const file = getActiveFile("js");
				if (file) file.content = jsEditor.getValue();
				schedulePreviewUpdate();
				scheduleSave();
			});

			renderAllFileLists();
			updateFileNameInputs();
			renderPreview();
			updateStatus();

			if (themeMedia.addEventListener) {
				themeMedia.addEventListener("change", (event) => {
					monaco.editor.setTheme(event.matches ? "baramDark" : "baramLight");
				});
			} else if (themeMedia.addListener) {
				themeMedia.addListener((event) => {
					monaco.editor.setTheme(event.matches ? "baramDark" : "baramLight");
				});
			}
		});

		projectNameInput.addEventListener("input", () => {
			project.name = projectNameInput.value.trim() || "Baram Live Preview";
			document.title = project.name;
			scheduleSave();
		});

		autoUpdateInput.addEventListener("change", () => {
			project.settings.autoUpdate = autoUpdateInput.checked;
			updateStatus();
			scheduleSave();
			if (autoUpdateInput.checked && changePending) renderPreview();
		});

		cssHotInput.addEventListener("change", () => {
			project.settings.cssHot = cssHotInput.checked;
			scheduleSave();
			if (cssHotInput.checked && cssPending) updateCssOnly(project.active.css);
		});

		runBtn.addEventListener("click", () => {
			renderPreview();
			scheduleSave();
		});

		openTabBtn.addEventListener("click", () => {
			previewWindow = window.open("", "baram-preview");
			if (!previewWindow) {
				alert("Popup blocked. Allow popups to open the preview tab.");
				return;
			}
			renderPreview();
		});

		downloadBtn.addEventListener("click", () => {
			downloadZip();
		});

		backBtn.addEventListener("click", () => {
			window.location.href = "welcome.html";
		});

		previewLayoutButtons.forEach((btn) => {
			btn.addEventListener("click", () => setPreviewLayout(btn.dataset.layout));
		});

		editorLayoutButtons.forEach((btn) => {
			btn.addEventListener("click", () => setEditorLayout(btn.dataset.layout));
		});

		if (toggleFilesBtn) {
			toggleFilesBtn.addEventListener("click", () => {
				setFilesCollapsed(!workspace.classList.contains("files-collapsed"));
			});
		}

		if (toggleFilesPanelBtn) {
			toggleFilesPanelBtn.addEventListener("click", () => {
				setFilesCollapsed(!workspace.classList.contains("files-collapsed"));
			});
		}

		groupToggles.forEach((btn) => {
			btn.addEventListener("click", () => {
				const type = btn.dataset.type;
				const group = document.querySelector(`.file-group[data-type="${type}"]`);
				if (!group) return;
				const next = !group.classList.contains("group-collapsed");
				setGroupCollapsed(type, next);
			});
		});

		addFileButtons.forEach((btn) => {
			btn.addEventListener("click", () => addFile(btn.dataset.type));
		});

		resizeHandles.forEach((handle) => {
			handle.addEventListener("pointerdown", (event) => {
				event.preventDefault();
				startResize(handle, event);
			});
		});

		if (previewResize) {
			previewResize.addEventListener("pointerdown", (event) => {
				event.preventDefault();
				startPreviewResize(event);
			});
		}

		htmlNameInput.addEventListener("change", () => renameActiveFile("html", htmlNameInput.value));
		cssNameInput.addEventListener("change", () => renameActiveFile("css", cssNameInput.value));
		jsNameInput.addEventListener("change", () => renameActiveFile("js", jsNameInput.value));

		const savedEditorLayout = project.settings.editorLayout || "block";
		const savedPreviewLayout = project.settings.previewLayout || "right";
		project.settings.editorLayout = savedEditorLayout;
		setPreviewLayout(savedPreviewLayout);

		const savedFilesCollapsed = project.settings.filesCollapsed || false;
		setFilesCollapsed(savedFilesCollapsed);

		const savedGroupCollapsed = project.settings.groupCollapsed || { html: false, css: false, js: false };
		setGroupCollapsed("html", savedGroupCollapsed.html);
		setGroupCollapsed("css", savedGroupCollapsed.css);
		setGroupCollapsed("js", savedGroupCollapsed.js);

		window.addEventListener("resize", () => {
			updateResizeHandles();
			applyEditorSizes();
			applyPreviewSize();
		});
	</script>
	<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Baram Code Editor",
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Web Browser",
  "browserRequirements": "Requires JavaScript and LocalStorage",
  "featureList": [
    "Instant Start with no login",
    "Real-time HTML/CSS/JS Preview",
    "Hot Reloading",
    "Auto-save to LocalStorage",
    "Multi-file management",
    "ZIP Export"
  ],
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "JPY"
  }
}
</script>
<script src="./baram/baram-editor-main.js"></script>
</body>

</html>
